var dependencies=["ionic","w5c.validator","angular-jwt","monospaced.qrcode","btford.socket-io","ngCordova","yiyangbao.services","yiyangbao.directives","yiyangbao.filters","yiyangbao.controllers","yiyangbao.controllers.user","yiyangbao.controllers.backend","baiduMap"],myAppVersion="0.0.1";if(!navigator.connection)var Connection={NONE:!1};var app=angular.module("yiyangbao",dependencies);app.config(["$stateProvider","$urlRouterProvider","$urlMatcherFactoryProvider","$locationProvider","$provide","CONFIG",function($stateProvider,$urlRouterProvider,$urlMatcherFactoryProvider,$locationProvider,$provide,CONFIG){var ACL=function(){function buildRoles(roles){var bitMask="01",userRoles={};for(var role in roles){var intCode=parseInt(bitMask,2);userRoles[roles[role]]={bitMask:intCode,title:roles[role]},bitMask=(intCode<<1).toString(2)}return userRoles}function buildAccessLevels(accessLevelDeclarations,userRoles){var resultBitMask,accessLevels={};for(var level in accessLevelDeclarations)if("string"==typeof accessLevelDeclarations[level])if("*"==accessLevelDeclarations[level]){resultBitMask="";for(var r in userRoles)resultBitMask+="1";accessLevels[level]={bitMask:parseInt(resultBitMask,2)}}else console.log("Access Control Error: Could not parse '"+accessLevelDeclarations[level]+"' as access definition for level '"+level+"'");else{resultBitMask=0;for(var role in accessLevelDeclarations[level])userRoles.hasOwnProperty(accessLevelDeclarations[level][role])?resultBitMask|=userRoles[accessLevelDeclarations[level][role]].bitMask:console.log("Access Control Error: Could not find role '"+accessLevelDeclarations[level][role]+"' in registered roles while building access for '"+level+"'");accessLevels[level]={bitMask:resultBitMask}}return accessLevels}var userRoles=buildRoles(CONFIG.userRoles),accessLevels=buildAccessLevels(CONFIG.accessLevels,userRoles);return{userRoles:userRoles,accessLevels:accessLevels}},acl=ACL(),access=acl.accessLevels;$provide.service("ACL",function(){return acl}),$urlMatcherFactoryProvider.strictMode(!1),$stateProvider.state("intro",{url:"/intro",templateUrl:"partials/about/intro.html",controller:"intro",data:{access:access["public"]}}),$stateProvider.state("public",{"abstract":!0,templateUrl:"partials/sideMenuLeft.html",controller:"publicSideMenu",data:{access:access["public"]}}).state("public.aboutUs",{url:"/aboutUs",templateUrl:"partials/about/aboutUs.html",data:{menuToggle:!0},controller:"aboutUs"}).state("public.agreement",{url:"/agreement",templateUrl:"partials/about/agreement.html",data:{menuToggle:!0},controller:"agreement"}).state("public.settings",{url:"/settings",templateUrl:"partials/about/settings.html",data:{menuToggle:!0},controller:"settings"}).state("public.feedback",{url:"/feedback",templateUrl:"partials/about/feedback.html",controller:"feedback"}),$stateProvider.state("user",{"abstract":!0,url:"/user",templateUrl:"partials/user/tabsBottom.html",controller:"userTabsBottom",data:{access:access.user}}).state("user.home",{url:"/home",data:{menuToggle:!0},views:{userHome:{templateUrl:"partials/user/home.html",controller:"userHome"}}}).state("user.apply",{url:"/apply",views:{userHome:{templateUrl:"partials/user/apply.html",controller:"userApply"}}}).state("user.ConsList",{url:"/ConsList?action",data:{menuToggle:!0},views:{userConsList:{templateUrl:"partials/user/ConsList.html",controller:"userConsList"}}}).state("user.ConsDetail",{url:"/ConsDetail/:consId",params:{cons:null,conf:null},views:{userConsList:{templateUrl:"partials/user/ConsDetail.html",controller:"userConsDetail"}}}).state("user.activities",{url:"/activities",views:{userActivities:{templateUrl:"partials/user/activities.html",controller:"userActivities"}}}).state("user.around",{url:"/around",data:{menuToggle:!0},views:{userAround:{templateUrl:"partials/user/around.html",controller:"userAround"}}}).state("user.settings",{url:"/settings",views:{userHome:{templateUrl:"partials/user/settings.html",controller:"userSettings"}}}).state("user.feedback",{url:"/feedback",views:{userHome:{templateUrl:"partials/user/feedback.html",controller:"userFeedback"}}}).state("user.mine",{url:"/mine?action",views:{userHome:{templateUrl:"partials/user/mine.html",controller:"userMine"}}}).state("user.helper",{url:"/helper",views:{userHome:{templateUrl:"partials/user/helper.html",controller:"userHelper"}}}).state("user.search",{url:"/search",views:{userConsList:{templateUrl:"partials/common/search.html",controller:"userSearch"}}}).state("user.health",{url:"/health",views:{userHome:{templateUrl:"partials/user/health.html",controller:"userHealth"}}}).state("user.onlinecart",{url:"/onlinecart",views:{userHome:{templateUrl:"partials/user/onlinecart.html",controller:"userOnlinecart"}}}).state("user.kenbei",{url:"/kenbei",views:{userHome:{templateUrl:"partials/user/kenbei.html",controller:"userKenbei"}}}).state("user.bxproduct",{url:"/bxproduct",views:{userHome:{templateUrl:"partials/user/bxproduct.html",controller:"userBxproduct"}}}).state("user.myguang",{url:"/myguang",views:{userHome:{templateUrl:"partials/user/myguang.html",controller:"userMyguang"}}}).state("user.yangsheng",{url:"/yangsheng",views:{userHome:{templateUrl:"partials/user/yangsheng.html",controller:"userYangsheng"}}}).state("user.article",{url:"/article/:typeid/:id",views:{userHome:{templateUrl:"partials/user/article.html",controller:"userArticle"}}}),$stateProvider.state("serv",{"abstract":!0,url:"/serv",templateUrl:"partials/backend/serv/tabsBottom.html",controller:"servTabsBottom",data:{access:access.serv}}).state("serv.barcode",{url:"/barcode:barcode",views:{servBarcode:{templateUrl:"partials/backend/serv/barcode.html",controller:"servBarcode"}}}).state("serv.ConsList",{url:"/ConsList",views:{servConsList:{templateUrl:"partials/backend/serv/ConsList.html",controller:"servConsList"}}}).state("serv.ConsDetail",{url:"/ConsDetail/:consId",params:{cons:null},views:{servConsList:{templateUrl:"partials/backend/serv/ConsDetail.html",controller:"servConsDetail"}}}).state("serv.home",{url:"/home",views:{servHome:{templateUrl:"partials/backend/serv/home.html",controller:"servHome"}}}).state("serv.mine",{url:"/mine",views:{servHome:{templateUrl:"partials/backend/serv/mine.html",controller:"servMine"}}}).state("serv.settings",{url:"/settings",views:{servHome:{templateUrl:"partials/backend/serv/settings.html",controller:"servSettings"}}}).state("serv.helper",{url:"/helper",views:{servHome:{templateUrl:"partials/backend/serv/helper.html",controller:"servHelper"}}}).state("serv.feedback",{url:"/feedback",views:{servHome:{templateUrl:"partials/backend/serv/feedback.html",controller:"servFeedback"}}}).state("serv.search",{url:"/search",views:{servConsList:{templateUrl:"partials/common/search.html",controller:"servSearch"}}}),$stateProvider.state("medi",{"abstract":!0,url:"/medi",templateUrl:"partials/backend/medi/tabsBottom.html",controller:"mediTabsBottom",data:{access:access.medi}}).state("medi.barcode",{url:"/barcode",views:{mediBarcode:{templateUrl:"partials/backend/medi/barcode.html",controller:"mediBarcode"}}}).state("medi.ConsList",{url:"/ConsList",views:{mediConsList:{templateUrl:"partials/backend/medi/ConsList.html",controller:"mediConsList"}}}).state("medi.ConsDetail",{url:"/ConsDetail/:consId",params:{cons:null},views:{mediConsList:{templateUrl:"partials/backend/medi/ConsDetail.html",controller:"mediConsDetail"}}}).state("medi.home",{url:"/home",views:{mediHome:{templateUrl:"partials/backend/medi/home.html",controller:"mediHome"}}}).state("medi.mine",{url:"/mine",views:{mediHome:{templateUrl:"partials/backend/medi/mine.html",controller:"mediMine"}}}).state("medi.settings",{url:"/settings",views:{mediHome:{templateUrl:"partials/backend/medi/settings.html",controller:"mediSettings"}}}).state("medi.helper",{url:"/helper",views:{mediHome:{templateUrl:"partials/backend/medi/helper.html",controller:"mediHelper"}}}).state("medi.feedback",{url:"/feedback",views:{mediHome:{templateUrl:"partials/backend/medi/feedback.html",controller:"mediFeedback"}}}).state("medi.search",{url:"/search",views:{mediConsList:{templateUrl:"partials/common/search.html",controller:"mediSearch"}}}).state("medi.receipt",{url:"/receipt",views:{mediReceipt:{templateUrl:"partials/backend/medi/receipt.html",controller:"mediReceipt"}}})}]).config(["$ionicConfigProvider",function($ionicConfigProvider){$ionicConfigProvider.views.maxCache(10),$ionicConfigProvider.views.forwardCache(!0),$ionicConfigProvider.backButton.icon("ion-ios7-arrow-back"),$ionicConfigProvider.backButton.text(""),$ionicConfigProvider.backButton.previousTitleText(!1),$ionicConfigProvider.tabs.position("bottom"),$ionicConfigProvider.navBar.alignTitle("center")}]).config(["$httpProvider","jwtInterceptorProvider",function($httpProvider,jwtInterceptorProvider){jwtInterceptorProvider.tokenGetter=["config","jwtHelper","$http","CONFIG","Storage",function(config,jwtHelper,$http,CONFIG,Storage){var token=Storage.get("token"),refreshToken=Storage.get("refreshToken");if(!token&&!refreshToken)return null;var isExpired=!0;try{isExpired=jwtHelper.isTokenExpired(token)}catch(e){isExpired=!0}return".html"===config.url.substr(config.url.length-5)||".js"===config.url.substr(config.url.length-3)||".css"===config.url.substr(config.url.length-4)||".jpg"===config.url.substr(config.url.length-4)||".png"===config.url.substr(config.url.length-4)||".ico"===config.url.substr(config.url.length-4)||".woff"===config.url.substr(config.url.length-5)?null:isExpired?refreshToken&&refreshToken.length>=16?$http({url:CONFIG.baseUrl+"refreshToken",skipAuthorization:!0,method:"POST",timeout:5e3,data:{grant_type:"refresh_token",refresh_token:refreshToken}}).then(function(res){return Storage.set("token",res.data.token),Storage.set("refreshToken",res.data.refreshToken),res.data.token},function(err){return console.log(err),null}):(Storage.rm("refreshToken"),null):token}],$httpProvider.interceptors.push("jwtInterceptor")}]).config(["w5cValidatorProvider",function(w5cValidatorProvider){w5cValidatorProvider.config({blurTrig:!1,showError:!0,removeError:!0}),w5cValidatorProvider.setRules({email:{required:"邮箱地址不能为空",email:"输入邮箱的格式不正确"},username:{required:"输入的用户名不能为空",pattern:"用户名只能包含字母, 数字, 下划线"},password:{required:"密码不能为空",minlength:"密码长度不能小于{minlength}",maxlength:"密码长度不能大于{maxlength}"},repeatPassword:{required:"密码不能为空",repeat:"两次填写的密码不一致"},oldPassword:{required:"密码不能为空",minlength:"密码长度不能小于{minlength}",maxlength:"密码长度不能大于{maxlength}"},newPassword:{required:"密码不能为空",minlength:"密码长度不能小于{minlength}",maxlength:"密码长度不能大于{maxlength}"},repeatPwd:{required:"密码不能为空",repeat:"两次填写的密码不一致"},oldDealPassword:{required:"密码不能为空",minlength:"密码长度不能小于{minlength}",maxlength:"密码长度不能大于{maxlength}"},newDealPassword:{required:"密码不能为空",minlength:"密码长度不能小于{minlength}",maxlength:"密码长度不能大于{maxlength}"},name:{required:"姓名不能为空",pattern:"请正确输入中文姓名"},mobile:{required:"手机号不能为空",pattern:"请填写正确手机号",minlength:"手机号长度不能小于{minlength}",maxlength:"手机号长度不能大于{maxlength}"},tel:{pattern:"请填写正确电话号",minlength:"电话号长度不能小于{minlength}",maxlength:"电话号长度不能大于{maxlength}"},idNo:{required:"证件号不能为空",pattern:"请填写正确证件号",minlength:"证件号长度不能小于{minlength}",maxlength:"证件号长度不能大于{maxlength}"},money:{required:"金额不能为空",min:"最小金额0.01元"}})}]).run(["$ionicPlatform","$rootScope","$state","Storage","Token","$ionicPopup",function($ionicPlatform,$rootScope,$state,Storage,Token,$ionicPopup){$ionicPlatform.ready(function(){switch(window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&StatusBar.styleDefault(),navigator.connection?$rootScope.myOnline=navigator.connection.type:$rootScope.myOnline=window.navigator.onLine,$ionicPlatform.on("online",function(){navigator.connection?$rootScope.myOnline=navigator.connection.type:$rootScope.myOnline=window.navigator.onLine,$rootScope.$broadcast("onOnline")},!1),$ionicPlatform.on("offline",function(){navigator.connection?$rootScope.myOnline=navigator.connection.type:$rootScope.myOnline=window.navigator.onLine,$rootScope.$broadcast("onOffline")},!1),Token.curUserRole()){case"public":$state.go("public.aboutUs");break;case"user":$state.go("user.home");break;case"serv":$state.go("serv.home");break;case"medi":$state.go("medi.home");break;default:$state.go("public.aboutUs")}})}]).run(["$rootScope","$state","$ionicHistory","Auth","ACL","Token","User","Storage","PageFunc",function($rootScope,$state,$ionicHistory,Auth,ACL,Token,User,Storage,PageFunc){$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){"data"in toState&&"access"in toState.data?!Auth.authorize(toState.data.access)||Auth.isLoggedIn()||Storage.get("refreshToken")||toState.data.access.bitMask===ACL.accessLevels["public"].bitMask||toState.data.access.bitMask===ACL.accessLevels.anon.bitMask?Auth.authorize(toState.data.access)||(event.preventDefault(),Auth.isLoggedIn()?(PageFunc.message("页面不存在或不能浏览!",2e3),$state.go(fromState.name||"user.home")):($rootScope.state={toStateName:toState.name,fromStateName:fromState.name},User.loginModal($rootScope))):(event.preventDefault(),$rootScope.state={toStateName:toState.name,fromStateName:fromState.name},User.loginModal($rootScope)):(event.preventDefault(),PageFunc.message("当前内容建设中, 敬请期待!",2e3),$state.go(fromState.name||"anon.login")),toState.data.menuToggle&&$ionicHistory.nextViewOptions({disableBack:!0})})}]),angular.module("yiyangbao.controllers.backend",[]).controller("mediTabsBottom",["$scope","$timeout","$state","$cordovaBarcodeScanner",function($scope,$timeout,$state,$cordovaBarcodeScanner){$scope.newConsNum=1,$scope.actions={clearConsBadge:function(){$timeout(function(){$scope.newConsNum=0},500)}}}]).controller("mediBarcode",["$scope","$state","$cordovaBarcodeScanner","$ionicHistory","PageFunc","Insurance","Consumption","User","Socket","Storage",function($scope,$state,$cordovaBarcodeScanner,$ionicHistory,PageFunc,Insurance,Consumption,User,Socket,Storage){$scope.error={};var payingPopup,inceInfo;$scope.actions={scan:function(event){return $scope.error.checkError="",window.cordova&&window.cordova.plugins&&window.cordova.plugins.barcodeScanner?void $cordovaBarcodeScanner.scan().then(function(result){if(result.cancelled)return $ionicHistory.goBack(0),$scope.error.checkError="用户取消";var barcode=result.text;$scope.payBill={mediId:JSON.parse(Storage.get("info"))._id,userSocketId:barcode.split(")|(")[0],available:barcode.split(")|(")[1]},inceInfo=null,void 0===$scope.payBill.available&&(barcode=$scope.payBill.userSocketId,Insurance.getInfo({seriesNum:barcode}).then(function(data){inceInfo=data.results,$scope.payBill.available=data.results.amountInfo.available,$scope.dealPwd=data.results.user.dealPwd},function(err){$scope.error.checkError=err.data}))},function(err){console.log(err),$scope.error.checkError=err}):$scope.error.checkError="不支持cordova.plugins.barcodeScanner"},check:function(){inceInfo?$scope.dealPwd===!0?PageFunc.prompt("支付密码","请输入支付密码").then(function(res){if(res){var ince=inceInfo.ince,cons={userId:inceInfo.user._id,money:$scope.payBill.money,consType:"medi",note:$scope.payBill.note,seriesNum:ince.seriesNum,mediId:$scope.payBill.mediId,incePolicyId:ince._id,unitId:ince.unitId,inceId:ince.inceId,servId:ince.servId,password:res};Consumption.insertOne(cons).then(function(data){$scope.error.checkError="用户支付"+data.results.cons.money+"元",$scope.payBill.money=null,$scope.payBill.available=void 0},function(err){$scope.error.checkError=err.data})}else $scope.error.checkError="未输入密码!"}):User.dealPasswordModal($scope,null,!0):(Socket["default"].emit("pay bill",$scope.payBill,"check"),payingPopup=PageFunc.message("用户支付中..."))}},Socket["default"].on("pay bill",function(data,actions,options,cb){("paid"===actions||"payError"===actions||"cancelPay"===actions)&&(payingPopup.close(data),$scope.error.checkError=data.msg||"用户取消支付","paid"===actions&&($scope.payBill.money=null,$scope.payBill.available=void 0))});var unbindModalHidden=$scope.$on("modal.hidden",function(){$scope.error.checkError="取消输入"});$scope.$on("$destroy",function(){Socket.getSocket().removeAllListeners(),unbindModalHidden(),unbindModalHidden=null})}]).controller("mediConsList",["$scope","$q","$ionicPopover","Consumption",function($scope,$q,$ionicPopover,Consumption){var batch=null,lastTime=null,consList=[],init=function(){var deferred=$q.defer();return Consumption.getList(null,{skip:0,limit:batch}).then(function(data){consList=data.results,$scope.items=consList.filter(function(item){return!item.status.isSubmitted&&!item.status.isAudited&&!item.status.isRevoked&&!item.status.isDone||item.status.isSubmitted&&!item.status.isAudited&&!item.status.isRevoked&&!item.status.isDone&&$scope.filters.checkBoxItems[0].checked===!0||item.status.isAudited&&!item.status.isDone&&$scope.filters.checkBoxItems[1].checked===!0||item.status.isRevoked&&$scope.filters.checkBoxItems[2].checked===!0||item.status.isDone&&$scope.filters.checkBoxItems[3].checked===!0?(item.receiptImg&&item.receiptImg[0]&&(item.receiptImgUrl=item.receiptImg[0].Url.replace(/\/([^\/]+?\.[^\/]+?)$/,"/thumb/sm_$1")),!0):void 0}),lastTime=Date.now(),deferred.resolve()},function(err){console.log(err.data),deferred.reject()}),deferred.promise};$scope.$on("$ionicView.beforeEnter",function(){var thisMoment=Date.now();(thisMoment-lastTime)/36e5>1&&init()}),$scope.filters={title:"消费记录筛选",isCheckBox:!0,checkBoxItems:[{text:"已提交",checked:!1},{text:"已审核",checked:!1},{text:"已核销",checked:!1},{text:"已完成",checked:!1}],height:"280px"},$ionicPopover.fromTemplateUrl("partials/popover/filter.html",{scope:$scope}).then(function(popover){$scope.filterPopover=popover}),$scope.$on("$destroy",function(){$scope.filterPopover.remove()}),$scope.actions={doRefresh:function(){init()["catch"](function(err){console.log(err)})["finally"](function(){$scope.$broadcast("scroll.refreshComplete")})},showFilter:function($event){$scope.filterPopover.show($event)},closeFilter:function(){$scope.filterPopover.hide()},filterItems:function(){$scope.items=consList.filter(function(item){return!item.status.isSubmitted&&!item.status.isAudited&&!item.status.isRevoked&&!item.status.isDone||item.status.isSubmitted&&!item.status.isAudited&&!item.status.isRevoked&&!item.status.isDone&&$scope.filters.checkBoxItems[0].checked===!0||item.status.isAudited&&!item.status.isDone&&$scope.filters.checkBoxItems[1].checked===!0||item.status.isRevoked&&$scope.filters.checkBoxItems[2].checked===!0||item.status.isDone&&$scope.filters.checkBoxItems[3].checked===!0?(item.receiptImg&&item.receiptImg[0]&&(item.receiptImgUrl=item.receiptImg[0].Url.replace(/\/([^\/]+?\.[^\/]+?)$/,"/thumb/sm_$1")),!0):void 0})}}}]).controller("mediConsDetail",["$q","$scope","$state","$stateParams","$cordovaCamera","$cordovaFileTransfer","$timeout","$ionicLoading","PageFunc","User","Consumption","CONFIG","Storage",function($q,$scope,$state,$stateParams,$cordovaCamera,$cordovaFileTransfer,$timeout,$ionicLoading,PageFunc,User,Consumption,CONFIG,Storage){$scope.error={};var cameraOptions=CONFIG.cameraOptions,uploadOptions=CONFIG.uploadOptions;$scope.pageHandler={progress:0,showDelete:!1},$scope.actions={showDelete:function(){$scope.pageHandler.showDelete=!$scope.pageHandler.showDelete},deleteImg:function(item,$index){PageFunc.confirm("是否确认删除?","删除图片").then(function(res){res&&(Consumption.updateOne({_id:$stateParams.consId,pull:{Url:item.receiptImg[$index].Url,path:item.receiptImg[$index].path,title:item.receiptImg[$index].title}}).then(function(data){},function(err){$scope.error.receiptError=err.data,console.log(err.data)}),item.receiptImg.splice($index,1),item.receiptImgThumb.splice($index,1))})},takePic:function(){return window.navigator&&window.navigator.camera?void $cordovaCamera.getPicture(cameraOptions).then(function(imageURI){$timeout(function(){var serverUrl=encodeURI(CONFIG.baseUrl+CONFIG.consReceiptUploadPath);uploadOptions.headers={Authorization:"Bearer "+Storage.get("token")},uploadOptions.fileName=$stateParams.consId+CONFIG.uploadOptions.fileExt,uploadOptions.params={_id:$stateParams.consId},PageFunc.confirm("是否上传?","上传图片").then(function(res){if(res)return $ionicLoading.show({template:'<ion-spinner style="height:2em;width:2em"></ion-spinner>'}),window.FileTransfer?$cordovaFileTransfer.upload(serverUrl,imageURI,uploadOptions,!0).then(function(result){$scope.pageHandler.progress=0,$ionicLoading.hide(),$scope.error.receiptError="上传成功!",$scope.item.receiptImg=JSON.parse(result.response).results.receiptImg,$scope.item.receiptImgThumb=$scope.item.receiptImg.filter(function(img){return img&&(img.urlThumb=img.Url.replace(/\/([^\/]+?\.[^\/]+?)$/,"/thumb/$1")),!0});try{$cordovaCamera.cleanup().then(function(){},function(err){console.log(err)})}catch(e){console.log(e)}},function(err){console.log(err),$scope.error.receiptError=err,$scope.pageHandler.progress=0,$ionicLoading.hide();try{$cordovaCamera.cleanup().then(function(){},function(err){console.log(err)})}catch(e){console.log(e)}},function(progress){$scope.pageHandler.progress=progress.loaded/progress.total*100}):console.log("不支持window.FileTransfer");$scope.pageHandler.progress=0,$scope.error.receiptError="取消上传!";try{$cordovaCamera.cleanup().then(function(){},function(err){console.log(err)})}catch(e){console.log(e)}})},0)},function(err){$scope.error.receiptError=err,console.log(err)}):console.log("不支持window.navigator.camera")},submit:function(){PageFunc.confirm("是否提交?","提交记录").then(function(res){return res?Consumption.updateOne({_id:$stateParams.consId,set:"submit"}).then(function(data){$scope.item=data.results,$scope.item.receiptImgThumb=$scope.item.receiptImg.filter(function(img){return img&&(img.urlThumb=img.Url.replace(/\/([^\/]+?\.[^\/]+?)$/,"/thumb/$1")),!0}),$scope.item.idImgThumb=$scope.item.userId.personalInfo.idImg.filter(function(img){return img&&(img.urlThumb=img.Url.replace(/\/([^\/]+?\.[^\/]+?)$/,"/thumb/$1")),!0}),$scope.error.receiptError="提交成功!"},function(err){$scope.error.receiptError=err.data,console.log(err.data)}):void 0})},doRefresh:function(){init(!0)["catch"](function(err){console.log(err)})["finally"](function(){$scope.$broadcast("scroll.refreshComplete")})},viewer:function($index,group){var images=group&&$scope.item.userId.personalInfo.idImg||$scope.item.receiptImg;PageFunc.viewer($scope,images,$index)},revoking:function(){PageFunc.prompt("请输入登录密码确认","是否退款?").then(function(res){res?User.verifyPwd(res).then(function(data){"OK"===data.results&&Consumption.revoking({_id:$scope.item._id}).then(function(data){console.log(data.results),$scope.item=data.results,$scope.item.receiptImgThumb=$scope.item.receiptImg.filter(function(img){return img&&(img.urlThumb=img.Url.replace(/\/([^\/]+?\.[^\/]+?)$/,"/thumb/$1")),!0}),$scope.item.idImgThumb=$scope.item.userId.personalInfo.idImg.filter(function(img){return img&&(img.urlThumb=img.Url.replace(/\/([^\/]+?\.[^\/]+?)$/,"/thumb/$1")),!0})},function(err){$scope.error.receiptError=err.data})},function(err){$scope.error.receiptError=err.data}):$scope.error.receiptError="用户取消!"})}};var init=function(refresh){var deferred=$q.defer();return $stateParams.cons&&!refresh?($scope.item=$stateParams.cons,$scope.item.receiptImgThumb=$scope.item.receiptImg.filter(function(img){return img&&(img.urlThumb=img.Url.replace(/\/([^\/]+?\.[^\/]+?)$/,"/thumb/$1")),!0}),$scope.item.idImgThumb=$scope.item.userId.personalInfo.idImg.filter(function(img){return img&&(img.urlThumb=img.Url.replace(/\/([^\/]+?\.[^\/]+?)$/,"/thumb/$1")),!0}),deferred.resolve()):Consumption.getOne({_id:$stateParams.consId}).then(function(data){$scope.item=data.results,$scope.item.receiptImgThumb=$scope.item.receiptImg.filter(function(img){return img&&(img.urlThumb=img.Url.replace(/\/([^\/]+?\.[^\/]+?)$/,"/thumb/$1")),!0}),$scope.item.idImgThumb=$scope.item.userId.personalInfo.idImg.filter(function(img){return img&&(img.urlThumb=img.Url.replace(/\/([^\/]+?\.[^\/]+?)$/,"/thumb/$1")),!0}),deferred.resolve()},function(err){deferred.reject(),console.log(err.data)}),deferred.promise};init()}]).controller("mediHome",["$scope","Storage","$q","User","PageFunc",function($scope,Storage,$q,User,PageFunc){User.initInfo($scope),$scope.actions={doRefresh:function(){User.initInfo($scope)["catch"](function(err){console.log(err)})["finally"](function(){$scope.$broadcast("scroll.refreshComplete")})},viewer:function($index){var images=$scope.info.idImgThumb;PageFunc.viewer($scope,images,$index)}}}]).controller("mediMine",["$scope","$ionicPopup","$q","$ionicActionSheet","$cordovaCamera","$cordovaFileTransfer","Storage","User","$timeout","PageFunc","CONFIG","Token",function($scope,$ionicPopup,$q,$ionicActionSheet,$cordovaCamera,$cordovaFileTransfer,Storage,User,$timeout,PageFunc,CONFIG,Token){$scope.config={q1:CONFIG.q1,q2:CONFIG.q2,q3:CONFIG.q3,images:[{title:"营业执照"},{title:"机构照片"}]},$scope.pageHandler={progress:0},$scope.data={};var cameraOptions=angular.copy(CONFIG.cameraOptions),uploadOptions=angular.copy(CONFIG.uploadOptions);User.initInfo($scope),$scope.actions={doRefresh:function(){User.initInfo($scope)["catch"](function(err){console.log(err)})["finally"](function(){$scope.$broadcast("scroll.refreshComplete")})},chgHead:function(){$ionicActionSheet.show({buttons:[{text:"<b>拍摄头像</b>"},{text:"相册照片"}],titleText:"设置头像",cancelText:"取消",cancel:function(){},buttonClicked:function(index){switch(cameraOptions.allowEdit=!0,cameraOptions.targetWidth=800,cameraOptions.targetHeight=800,cameraOptions.cameraDirection=1,index){case 0:cameraOptions.sourceType=1;break;case 1:cameraOptions.sourceType=2}return window.navigator&&window.navigator.camera?($cordovaCamera.getPicture(cameraOptions).then(function(imageURI){$timeout(function(){var serverUrl=encodeURI(CONFIG.baseUrl+CONFIG.userResUploadPath);uploadOptions.headers={Authorization:"Bearer "+Storage.get("token")},uploadOptions.fileName="userHead"+CONFIG.uploadOptions.fileExt,uploadOptions.params={method:"$set",dest:"head",replace:!0},PageFunc.confirm("是否上传?","上传头像").then(function(res){if(res)return window.FileTransfer?$cordovaFileTransfer.upload(serverUrl,imageURI,uploadOptions,!0).then(function(result){$scope.pageHandler.progress=0,$scope.info.head={Url:JSON.parse(result.response).results.Url};try{$cordovaCamera.cleanup().then(function(){console.log("Camera cleanup success.")},function(err){console.log(err)})}catch(e){console.log(e)}},function(err){console.log(err),$scope.error.headError=err,$scope.pageHandler.progress=0;try{$cordovaCamera.cleanup().then(function(){console.log("Camera cleanup success.")},function(err){console.log(err)})}catch(e){console.log(e)}},function(progress){$scope.pageHandler.progress=progress.loaded/progress.total*100}):console.log("不支持window.fileTransfer");$scope.pageHandler.progress=0,$scope.error.headError="取消上传!";try{$cordovaCamera.cleanup().then(function(){console.log("Camera cleanup success.")},function(err){console.log(err)})}catch(e){console.log(e)}})},0)},function(err){$scope.error.headError=err,console.log(err)}),!0):console.log("不支持window.navigator.camera")}})},chgUsername:function(){$scope.info.username===$scope.info.personalInfo.idNo&&($scope.config.title="修改用户名",$scope.data.key="username",$scope.data.value=$scope.info.username,$scope.actions.show())},chgMobile:function(){var smsType,title,msg;$scope.info.mobile?(smsType="-chgBind",title="修改手机号",msg="请输入当前绑定手机号"):(smsType="-initBind",title="绑定手机号",msg="请输入手机号"),$scope.bindMobileModal?$scope.bindMobileModal.show():User.bindMobileModal(Token.curUserRole(),smsType,$scope.info.mobile,title,msg,!0)},chgEmail:function(){$scope.config.title="修改邮箱地址",$scope.data.key="email",$scope.data.value=$scope.info.email,$scope.actions.show()},chgPwd:function(){$scope.passwordModal?$scope.passwordModal.show():User.passwordModal($scope)},chgPwdQst:function(){PageFunc.prompt("登录密码","请输入登录密码").then(function(res){res&&User.verifyPwd(res).then(function(data){"OK"===data.results&&($scope.config.title="设置密保问题",$scope.pwdQstModal?$scope.pwdQstModal.show():User.pwdQstModal($scope))},function(err){console.log(err.data)})})},chgName:function(){$scope.config.title="修改机构名",$scope.data.key="personalInfo.name",$scope.data.value=$scope.info.personalInfo.name,$scope.actions.show()},chgIdNo:function(){PageFunc.message('如有错误, 请联系服务专员修改!<br><a ng-href="tel:'+CONFIG.serv400.number+'">'+CONFIG.serv400.caption+"</a>")},chgLocation:function(){$scope.config.title="修改地址",$scope.data.key="personalInfo.location.city.name",$scope.data.value=$scope.info.personalInfo.location&&$scope.info.personalInfo.location.city&&$scope.info.personalInfo.location.city.name,$scope.actions.show()},chgIdImg:function(){$scope.config.title="拍摄机构照片",$scope.takePicsModal?$scope.takePicsModal.show():User.takePicsModal($scope,$scope.info.personalInfo.idImg)},chgIntro:function(){$scope.config.title="修改机构介绍",$scope.data.key="personalInfo.intro",$scope.data.value=$scope.info.personalInfo.intro,$scope.actions.show(!0)}},$scope.$on("$ionicView.loaded",function(){User.updateModal($scope)})}]).controller("mediSettings",["$scope","$ionicPopup","$q","Storage","User",function($scope,$ionicPopup,$q,Storage,User){User.initInfo($scope),$scope.actions={doRefresh:function(){User.initInfo($scope)["catch"](function(err){console.log(err)})["finally"](function(){$scope.$broadcast("scroll.refreshComplete")})},clearCache:function(){var token=Storage.get("token")||"",refreshToken=Storage.get("refreshToken")||"",myAppVersionLocal=Storage.get("myAppVersion")||"";Storage.clear(),token&&Storage.set("token",token),refreshToken&&Storage.set("refreshToken",refreshToken),myAppVersionLocal&&Storage.set("myAppVersion",myAppVersionLocal),$ionicPopup.alert({title:"缓存",template:"<h4><b>清理成功</b></h4>"})},logout:function(){User.logout($scope)}}}]).controller("mediHelper",["$scope",function($scope){}]).controller("mediFeedback",["$scope",function($scope){}]).controller("mediSearch",["$scope",function($scope){}]).controller("mediReceipt",["$scope",function($scope){}]).controller("servTabsBottom",["$scope","$timeout","$state","$cordovaBarcodeScanner","Insurance","PageFunc",function($scope,$timeout,$state,$cordovaBarcodeScanner,Insurance,PageFunc){$scope.newConsNum=1,$scope.actions={clearConsBadge:function(){$timeout(function(){$scope.newConsNum=0},500)}}}]).controller("servBarcode",["$scope","$state","$stateParams","$cordovaBarcodeScanner","$ionicHistory","PageFunc","Insurance","Consumption","User","Socket","Storage",function($scope,$state,$stateParams,$cordovaBarcodeScanner,$ionicHistory,PageFunc,Insurance,Consumption,User,Socket,Storage){$scope.error={},$scope.data={},$scope.actions={scan:function(event){return $scope.error.bindError="",window.cordova&&window.cordova.plugins&&window.cordova.plugins.barcodeScanner?void $cordovaBarcodeScanner.scan().then(function(result){return result.cancelled?($ionicHistory.goBack(0),$scope.error.bindError="用户取消"):($scope.data.barcode=result.text,void Insurance.getInfo({seriesNum:result.text}).then(function(data){PageFunc.message("该卡已被用户 <i>"+data.results.user.name+'</i> 绑定, <a href="'+data.results.user.mobile+'">联系'+(1===data.results.user.gender&&"他"||"她")+"</a>, <br>请换一张卡!",3e3)},function(err){return"保单不存在!"===err.data?$scope.error.bindError="卡号有效, 请绑定!":void PageFunc.message(err.data,3e3)}))},function(err){return console.log(err),$scope.error.bindError=err}):$scope.error.bindError="不支持cordova.plugins.barcodeScanner"},bindBarcode:function(){return $scope.data.query&&$scope.data.barcode?void User.bindBarcode($scope.data).then(function(data){return"OK"===data.results?($scope.data={},$scope.error.bindError="卡号绑定成功!"):void(data.results.length>0&&($scope.selection={inces:data.results},$scope.ince={selected:$scope.selection.inces[0]},PageFunc.selection('<select ng-options="_ince.unit for _ince in selection.inces" ng-model="ince.selected"></select>',"请选择需要绑定的保单","ince",$scope).then(function(res){res&&Insurance.modify({inceObj:{_id:res._id,seriesNum:$scope.data.barcode,userId:res.userId}}).then(function(data){$scope.data={},$scope.error.bindError="卡号绑定成功!"},function(err){console.log(err),$scope.error.bindError=err.data})})))},function(err){$scope.error.bindError=err.data}):void($scope.error.bindError="信息不完整, 请重新扫描或输入!");
}}}]).controller("servConsList",["$scope","$q","$ionicPopover","Consumption","PageFunc","$cordovaBarcodeScanner","$ionicHistory","Storage",function($scope,$q,$ionicPopover,Consumption,PageFunc,$cordovaBarcodeScanner,$ionicHistory,Storage){var batch=null,lastTime=null,consList=[],init=function(){var deferred=$q.defer(),authlist=JSON.parse(Storage.get("info")).extInfo.yiyangbaoHealInce.authorizedBy.filter(function(auth){return auth.isRevoked===!1?(delete auth.isRevoked,delete auth.unitName,!0):void 0});return Consumption.getList(authlist,{skip:0,limit:batch}).then(function(data){consList=data.results,$scope.items=consList.filter(function(item){return!item.status.isSubmitted&&!item.status.isAudited&&!item.status.isRevoked&&!item.status.isDone||item.status.isSubmitted&&!item.status.isAudited&&!item.status.isRevoked&&!item.status.isDone&&$scope.filters.checkBoxItems[0].checked===!0||item.status.isAudited&&!item.status.isDone&&$scope.filters.checkBoxItems[1].checked===!0||item.status.isRevoked&&$scope.filters.checkBoxItems[2].checked===!0||item.status.isDone&&$scope.filters.checkBoxItems[3].checked===!0?(item.receiptImg&&item.receiptImg[0]&&(item.receiptImgUrl=item.receiptImg[0].Url.replace(/\/([^\/]+?\.[^\/]+?)$/,"/thumb/sm_$1")),!0):void 0}),lastTime=Date.now(),deferred.resolve()},function(err){console.log(err.data),deferred.reject()}),deferred.promise};$scope.$on("$ionicView.beforeEnter",function(){var thisMoment=Date.now();(thisMoment-lastTime)/36e5>1&&init()}),$scope.filters={title:"消费记录筛选",isCheckBox:!0,checkBoxItems:[{text:"已提交",checked:!0},{text:"已审核",checked:!1},{text:"已核销",checked:!1},{text:"已完成",checked:!1}],height:"280px"},$ionicPopover.fromTemplateUrl("partials/popover/filter.html",{scope:$scope}).then(function(popover){$scope.filterPopover=popover}),$scope.$on("$destroy",function(){$scope.filterPopover.remove()}),$scope.actions={doRefresh:function(){init()["catch"](function(err){console.log(err)})["finally"](function(){$scope.$broadcast("scroll.refreshComplete")})},showFilter:function($event){$scope.filterPopover.show($event)},closeFilter:function(){$scope.filterPopover.hide()},filterItems:function(){$scope.items=consList.filter(function(item){return!item.status.isSubmitted&&!item.status.isAudited&&!item.status.isRevoked&&!item.status.isDone||item.status.isSubmitted&&!item.status.isAudited&&!item.status.isRevoked&&!item.status.isDone&&$scope.filters.checkBoxItems[0].checked===!0||item.status.isAudited&&!item.status.isDone&&$scope.filters.checkBoxItems[1].checked===!0||item.status.isRevoked&&$scope.filters.checkBoxItems[2].checked===!0||item.status.isDone&&$scope.filters.checkBoxItems[3].checked===!0?(item.receiptImg&&item.receiptImg[0]&&(item.receiptImgUrl=item.receiptImg[0].Url.replace(/\/([^\/]+?\.[^\/]+?)$/,"/thumb/sm_$1")),!0):void 0})},scan:function(event){return window.cordova&&window.cordova.plugins&&window.cordova.plugins.barcodeScanner?void $cordovaBarcodeScanner.scan().then(function(result){return result.cancelled?($ionicHistory.goBack(0),console.log("用户取消!")):void Consumption.getOne({_id:result.text}).then(function(data){var cons=data.results;$scope.items=consList.filter(function(item){return item._id===cons._id?cons.status.isRevoked===!0?PageFunc.message("申请已退回!",2e3):cons.status.isDone===!0?PageFunc.message("申请已通过!",2e3):!0:void 0}),0===$scope.items.length&&PageFunc.message("理赔申请不存在!",2e3)},function(err){PageFunc.message("理赔申请不存在!",2e3)})},function(err){PageFunc.message("扫码错误!",2e3)}):PageFunc.message("不支持扫码!",2e3)}}}]).controller("servConsDetail",["$q","$scope","$state","$stateParams","$cordovaCamera","$cordovaFileTransfer","$timeout","$ionicLoading","PageFunc","Consumption","CONFIG","Storage","$ionicScrollDelegate",function($q,$scope,$state,$stateParams,$cordovaCamera,$cordovaFileTransfer,$timeout,$ionicLoading,PageFunc,Consumption,CONFIG,Storage,$ionicScrollDelegate){$scope.error={},$scope.input={};var cameraOptions=CONFIG.cameraOptions,uploadOptions=CONFIG.uploadOptions;$scope.pageHandler={progress:0,showDelete:!1},$scope.actions={showDelete:function(){$scope.pageHandler.showDelete=!$scope.pageHandler.showDelete},deleteImg:function(item,$index){PageFunc.confirm("是否确认删除?","删除图片").then(function(res){res&&(Consumption.updateOne({_id:$stateParams.consId,pull:{Url:item.receiptImg[$index].Url,path:item.receiptImg[$index].path,title:item.receiptImg[$index].title}}).then(function(data){},function(err){$scope.error.receiptError=err.data,console.log(err.data)}),item.receiptImg.splice($index,1),item.receiptImgThumb.splice($index,1))})},takePic:function(){return window.navigator&&window.navigator.camera?void $cordovaCamera.getPicture(cameraOptions).then(function(imageURI){$timeout(function(){var serverUrl=encodeURI(CONFIG.baseUrl+CONFIG.consReceiptUploadPath);uploadOptions.headers={Authorization:"Bearer "+Storage.get("token")},uploadOptions.fileName=$stateParams.consId+CONFIG.uploadOptions.fileExt,uploadOptions.params={_id:$stateParams.consId},PageFunc.confirm("是否上传?","上传图片").then(function(res){if(res)return $ionicLoading.show({template:'<ion-spinner style="height:2em;width:2em"></ion-spinner>'}),window.FileTransfer?$cordovaFileTransfer.upload(serverUrl,imageURI,uploadOptions,!0).then(function(result){$scope.pageHandler.progress=0,$ionicLoading.hide(),$scope.error.receiptError="上传成功!",$scope.item.receiptImg=JSON.parse(result.response).results.receiptImg,$scope.item.receiptImgThumb=$scope.item.receiptImg.filter(function(img){return img&&(img.urlThumb=img.Url.replace(/\/([^\/]+?\.[^\/]+?)$/,"/thumb/$1")),!0});try{$cordovaCamera.cleanup().then(function(){},function(err){console.log(err)})}catch(e){console.log(e)}},function(err){console.log(err),$scope.error.receiptError=err,$scope.pageHandler.progress=0,$ionicLoading.hide();try{$cordovaCamera.cleanup().then(function(){},function(err){console.log(err)})}catch(e){console.log(e)}},function(progress){$scope.pageHandler.progress=progress.loaded/progress.total*100}):console.log("不支持window.FileTransfer");$scope.pageHandler.progress=0,$scope.error.receiptError="取消上传!";try{$cordovaCamera.cleanup().then(function(){},function(err){console.log(err)})}catch(e){console.log(e)}})},0)},function(err){$scope.error.receiptError=err,console.log(err)}):console.log("不支持window.navigator.camera")},submit:function(){PageFunc.confirm("是否提交?","提交记录").then(function(res){return res?Consumption.updateOne({_id:$stateParams.consId,set:"submit"}).then(function(data){$scope.item=data.results,$scope.item.receiptImgThumb=$scope.item.receiptImg.filter(function(img){return img&&(img.urlThumb=img.Url.replace(/\/([^\/]+?\.[^\/]+?)$/,"/thumb/$1")),!0}),$scope.error.receiptError="提交成功!"},function(err){$scope.error.receiptError=err.data,console.log(err.data)}):void 0})},doRefresh:function(){init(!0)["catch"](function(err){console.log(err)})["finally"](function(){$scope.$broadcast("scroll.refreshComplete")})},viewer:function($index,group){var images=group&&$scope.item.userId.personalInfo.idImg||$scope.item.receiptImg;PageFunc.viewer($scope,images,$index)},ask:function(){var comment={_id:$scope.item._id,content:$scope.input.message};Consumption.comment(comment).then(function(data){$scope.item.comments=data.results,$scope.input.message="",$ionicScrollDelegate.scrollBottom()},function(err){console.log(err)})}};var init=function(refresh){var deferred=$q.defer();return $stateParams.cons&&!refresh?($scope.item=$stateParams.cons,$scope.item.receiptImgThumb=$scope.item.receiptImg.filter(function(img){return img&&(img.urlThumb=img.Url.replace(/\/([^\/]+?\.[^\/]+?)$/,"/thumb/$1")),!0}),$scope.item.idImgThumb=$scope.item.userId.personalInfo.idImg.filter(function(img){return img&&(img.urlThumb=img.Url.replace(/\/([^\/]+?\.[^\/]+?)$/,"/thumb/$1")),!0}),deferred.resolve()):Consumption.getOne({_id:$stateParams.consId}).then(function(data){$scope.item=data.results,$scope.item.receiptImgThumb=$scope.item.receiptImg.filter(function(img){return img&&(img.urlThumb=img.Url.replace(/\/([^\/]+?\.[^\/]+?)$/,"/thumb/$1")),!0}),$scope.item.idImgThumb=$scope.item.userId.personalInfo.idImg.filter(function(img){return img&&(img.urlThumb=img.Url.replace(/\/([^\/]+?\.[^\/]+?)$/,"/thumb/$1")),!0}),deferred.resolve()},function(err){deferred.reject(),console.log(err.data)}),console.log($scope.item),deferred.promise};init()}]).controller("servHome",["$scope","Storage","$q","User","PageFunc",function($scope,Storage,$q,User,PageFunc){User.initInfo($scope),$scope.actions={doRefresh:function(){User.initInfo($scope)["catch"](function(err){console.log(err)})["finally"](function(){$scope.$broadcast("scroll.refreshComplete")})},viewer:function($index){var images=$scope.info.idImgThumb;PageFunc.viewer($scope,images,$index)}}}]).controller("servMine",["$scope","$ionicPopup","$q","$ionicActionSheet","$cordovaCamera","$cordovaFileTransfer","Storage","User","$timeout","PageFunc","CONFIG","Token",function($scope,$ionicPopup,$q,$ionicActionSheet,$cordovaCamera,$cordovaFileTransfer,Storage,User,$timeout,PageFunc,CONFIG,Token){$scope.config={q1:CONFIG.q1,q2:CONFIG.q2,q3:CONFIG.q3,images:[{title:"工作证正面"},{title:"工作证反面"}]},$scope.pageHandler={progress:0},$scope.data={};var cameraOptions=angular.copy(CONFIG.cameraOptions),uploadOptions=angular.copy(CONFIG.uploadOptions);User.initInfo($scope),$scope.actions={doRefresh:function(){User.initInfo($scope)["catch"](function(err){console.log(err)})["finally"](function(){$scope.$broadcast("scroll.refreshComplete")})},chgHead:function(){$ionicActionSheet.show({buttons:[{text:"<b>拍摄头像</b>"},{text:"相册照片"}],titleText:"设置头像",cancelText:"取消",cancel:function(){},buttonClicked:function(index){switch(cameraOptions.allowEdit=!0,cameraOptions.targetWidth=800,cameraOptions.targetHeight=800,cameraOptions.cameraDirection=1,index){case 0:cameraOptions.sourceType=1;break;case 1:cameraOptions.sourceType=2}return window.navigator&&window.navigator.camera?($cordovaCamera.getPicture(cameraOptions).then(function(imageURI){$timeout(function(){var serverUrl=encodeURI(CONFIG.baseUrl+CONFIG.userResUploadPath);uploadOptions.headers={Authorization:"Bearer "+Storage.get("token")},uploadOptions.fileName="userHead"+CONFIG.uploadOptions.fileExt,uploadOptions.params={method:"$set",dest:"head",replace:!0},PageFunc.confirm("是否上传?","上传头像").then(function(res){if(res)return window.FileTransfer?$cordovaFileTransfer.upload(serverUrl,imageURI,uploadOptions,!0).then(function(result){$scope.pageHandler.progress=0,$scope.info.head={Url:JSON.parse(result.response).results.Url};try{$cordovaCamera.cleanup().then(function(){console.log("Camera cleanup success.")},function(err){console.log(err)})}catch(e){console.log(e)}},function(err){console.log(err),$scope.error.headError=err,$scope.pageHandler.progress=0;try{$cordovaCamera.cleanup().then(function(){console.log("Camera cleanup success.")},function(err){console.log(err)})}catch(e){console.log(e)}},function(progress){$scope.pageHandler.progress=progress.loaded/progress.total*100}):console.log("不支持window.FileTransfer");$scope.pageHandler.progress=0,$scope.error.headError="取消上传!";try{$cordovaCamera.cleanup().then(function(){console.log("Camera cleanup success.")},function(err){console.log(err)})}catch(e){console.log(e)}})},0)},function(err){$scope.error.headError=err,console.log(err)}),!0):console.log("不支持window.navigator.camera")}})},chgUsername:function(){$scope.info.username===$scope.info.personalInfo.idNo&&($scope.config.title="修改用户名",$scope.data.key="username",$scope.data.value=$scope.info.username,$scope.actions.show())},chgMobile:function(){var smsType,title,msg;$scope.info.mobile?(smsType="-chgBind",title="修改手机号",msg="请输入当前绑定手机号"):(smsType="-initBind",title="绑定手机号",msg="请输入手机号"),$scope.bindMobileModal?$scope.bindMobileModal.show():User.bindMobileModal(Token.curUserRole(),smsType,$scope.info.mobile,title,msg,!0)},chgEmail:function(){$scope.config.title="修改邮箱地址",$scope.data.key="email",$scope.data.value=$scope.info.email,$scope.actions.show()},chgPwd:function(){$scope.passwordModal?$scope.passwordModal.show():User.passwordModal($scope)},chgPwdQst:function(){PageFunc.prompt("登录密码","请输入登录密码").then(function(res){res&&User.verifyPwd(res).then(function(data){"OK"===data.results&&($scope.config.title="设置密保问题",$scope.pwdQstModal?$scope.pwdQstModal.show():User.pwdQstModal($scope))},function(err){console.log(err.data)})})},chgName:function(){$scope.config.title="修改姓名",$scope.data.key="personalInfo.name",$scope.data.value=$scope.info.personalInfo.name,$scope.actions.show()},chgIdNo:function(){PageFunc.message('如有错误, 请联系服务专员修改!<br><a ng-href="tel:'+CONFIG.serv400.number+'">'+CONFIG.serv400.caption+"</a>")},chgLocation:function(){$scope.config.title="修改地址",$scope.data.key="personalInfo.location.city.name",$scope.data.value=$scope.info.personalInfo.location&&$scope.info.personalInfo.location.city&&$scope.info.personalInfo.location.city.name,$scope.actions.show()},chgIdImg:function(){$scope.config.title="拍摄相关照片",$scope.takePicsModal?$scope.takePicsModal.show():User.takePicsModal($scope,$scope.info.personalInfo.idImg)},chgIntro:function(){$scope.config.title="修改个人介绍",$scope.data.key="personalInfo.intro",$scope.data.value=$scope.info.personalInfo.intro,$scope.actions.show(!0)}},$scope.$on("$ionicView.loaded",function(){User.updateModal($scope)})}]).controller("servSettings",["$scope","$ionicPopup","$q","Storage","User",function($scope,$ionicPopup,$q,Storage,User){User.initInfo($scope),$scope.actions={doRefresh:function(){User.initInfo($scope)["catch"](function(err){console.log(err)})["finally"](function(){$scope.$broadcast("scroll.refreshComplete")})},clearCache:function(){var token=Storage.get("token")||"",refreshToken=Storage.get("refreshToken")||"",myAppVersionLocal=Storage.get("myAppVersion")||"";Storage.clear(),token&&Storage.set("token",token),refreshToken&&Storage.set("refreshToken",refreshToken),myAppVersionLocal&&Storage.set("myAppVersion",myAppVersionLocal),$ionicPopup.alert({title:"缓存",template:"<h4><b>清理成功</b></h4>"})},logout:function(){User.logout($scope)}}}]).controller("servHelper",["$scope",function($scope){}]).controller("servFeedback",["$scope",function($scope){}]).controller("servSearch",["$scope",function($scope){}]),angular.module("yiyangbao.controllers",[]).controller("main",["$scope",function($scope){}]).controller("intro",["$scope","Storage",function($scope,Storage){Storage.set("myAppVersion",myAppVersion)}]).controller("publicSideMenu",["$scope","$ionicPopup","Storage","User",function($scope,$ionicPopup,Storage,User){$scope.state={},$scope.sideMenu={firstItem:{click:function(){$scope.loginModal&&$scope.actions.showLogin?$scope.actions.showLogin():User.loginModal($scope)},title:"请登录",imgSrc:""},items:[{href:"#/aboutUs",iconClass:"ion-ios-information-outline",title:"关于我们"},{href:"#/agreement",iconClass:"ion-ios-compose-outline",title:"用户协议"},{href:"#/settings",iconClass:"ion-ios-gear-outline",title:"系统设置"}]}}]).controller("aboutUs",["$scope","User",function($scope,User){$scope.actions={loginModal:function(){$scope.loginModal&&$scope.actions.showLogin?$scope.actions.showLogin():User.loginModal($scope)}}}]).controller("agreement",["$scope",function($scope){}]).controller("settings",["$scope","$ionicPopup","Storage","User","CONFIG","Data","Socket",function($scope,$ionicPopup,Storage,User,CONFIG,Data,Socket){$scope.userName="王林",$scope.signature="",$scope.data={},$scope.actions={clearCache:function(){var token=Storage.get("token")||"",refreshToken=Storage.get("refreshToken")||"",myAppVersionLocal=Storage.get("myAppVersion")||"";Storage.clear(),token&&Storage.set("token",token),refreshToken&&Storage.set("refreshToken",refreshToken),myAppVersionLocal&&Storage.set("myAppVersion",myAppVersionLocal),$ionicPopup.alert({title:"缓存",template:"<h4><b>清理成功</b></h4>"})},chgServer:function(){CONFIG.baseUrl="http://"+$scope.data.server+"/",CONFIG.ioDefaultNamespace=$scope.data.server+"/default",Data.abort(),Socket["default"].disconnect(),Socket["new"](),console.log(CONFIG.baseUrl)},logout:function(){User.logout($scope)}}}]).controller("feedback",["$scope","$ionicHistory",function($scope,$ionicHistory){}]).controller("header",["$scope",function($scope){}]).controller("footer",["$scope",function($scope){}]),angular.module("yiyangbao.controllers.user",[]).controller("userTabsBottom",["$scope","$timeout",function($scope,$timeout){$scope.newConsNum=1,$scope.actions={clearConsBadge:function(){$timeout(function(){$scope.newConsNum=0},500)}}}]).controller("userHome",["$scope","$q","$timeout","PageFunc","Storage","User","Consumption","Socket","$ionicHistory",function($scope,$q,$timeout,PageFunc,Storage,User,Consumption,Socket,$ionicHistory){var init=function(){var deferred=$q.defer(),deferredInfo=$q.defer(),deferredBarcode=$q.defer();return User.initAccInfo($scope).then(function(data){deferredInfo.resolve(data)},function(err){deferredInfo.reject(err)}),Socket["default"].emit("pay bill",null,null,null,function(socketId){deferredBarcode.resolve(socketId)}),$timeout(function(){deferredBarcode.reject("连接超时!")},1e4),$q.all([deferredInfo.promise,deferredBarcode.promise]).then(function(data){$scope.accountInfo.barcode=data[1]+")|("+(data[0].amountInfo.available||0),deferred.resolve()},function(errors){console.log(errors),deferred.reject()}),deferred.promise};Socket["default"].on("pay bill",function(data,actions,options,cb){var AccInfo=JSON.parse(Storage.get("AccInfo")),userId=AccInfo.user._id,ince=AccInfo.inces.filter(function(ince){return"3"===ince.inceType?!0:void 0})[0]||{},socketData=data;"check"===actions&&PageFunc.prompt("消费金额: "+socketData.money+"元","请输入支付密码").then(function(res){if(res){var cons={userId:userId,money:socketData.money,consType:"medi",note:socketData.note,seriesNum:ince.seriesNum,mediId:socketData.mediId,incePolicyId:ince._id,unitId:ince.unitId,inceId:ince.inceId,servId:ince.servId,password:res};cons.outOrgUid=socketData.outOrgUid||void 0,cons.outShopUid=socketData.outShopUid||void 0,cons.outRecptNum=socketData.outRecptNum||void 0,cons.items=socketData.items||void 0,cons.status=socketData.status||void 0,Consumption.insertOne(cons).then(function(data){$scope.error.payError="您消费"+data.results.cons.money+"元!",Socket["default"].emit("pay bill",{mediSocketId:socketData.mediSocketId,msg:"用户支付"+data.results.cons.money+"元!"},"paid"),$scope.accountInfo.amountInfo.available=data.results.amountInfo.available,$scope.accountInfo.amountInfo.consumed=data.results.amountInfo.consumed,$scope.accountInfo.amountInfo.freeze=data.results.amountInfo.freeze,$scope.accountInfo.barcode=$scope.accountInfo.barcode.split(")|(")[0]+")|("+data.results.amountInfo.available},function(err){$scope.error.payError=err.data,Socket["default"].emit("pay bill",{mediSocketId:socketData.mediSocketId,msg:err.data},"payError")})}else Socket["default"].emit("pay bill",{mediSocketId:socketData.mediSocketId},"cancelPay")})}),$scope.actions={doRefresh:function(){init()["catch"](function(err){console.log(err)})["finally"](function(){$scope.$broadcast("scroll.refreshComplete")})}},$scope.$on("$ionicView.beforeEnter",function(){init()}),$scope.$on("$destroy",function(){Socket.getSocket().removeAllListeners()})}]).controller("userApply",["$scope","$state","User","Consumption","PageFunc","$ionicHistory","$ionicSlideBoxDelegate","$ionicLoading","CONFIG",function($scope,$state,User,Consumption,PageFunc,$ionicHistory,$ionicSlideBoxDelegate,$ionicLoading,CONFIG){$scope.config={relations:["本人","配偶","母/婚姻父母","子女","兄弟姐妹"],unitTypes:["pub","priv"],inceTypes:[],mediTypes:{},curMediTypes:[],out:[{title:"病历页"},{title:"发票"}],"in":[{title:"出院小结"},{title:"用药清单"},{title:"发票"}],images:[{title:"身份证正面"},{title:"身份证反面"},{title:"病历首页"},{title:"银行卡"}]},$scope.error={},$scope.data={};var inces={},slideIndex={};$scope.actions={apply:function(){"本人"===$scope.cons.consumer.relation&&($scope.cons.consumer={relation:"本人"}),"pub"===$scope.cons.unitType&&delete $scope.cons.prop,"priv"===$scope.cons.unitType&&delete $scope.cons.ownPay,Consumption.applyOne($scope.cons).then(function(data){$scope.cons={employeeId:$scope.accountInfo.user.personalInfo.employeeId,consumer:{idType:"身份证"},visitDate:{},status:{isSubmitted:!1,isRevoked:!1,isAudited:!1},consType:"self"},data.results.cons.userId=$scope.accountInfo.user,$state.go("user.ConsDetail",{consId:data.results.cons._id,cons:data.results.cons,conf:{showBarBtn:!0}})},function(err){$scope.error.applyError=err.data})},doRefresh:function(){User.initAccInfo($scope).then(function(data){$scope.config.inceTypes=[];for(var i=0;i<data.inces.length;i++){$scope.config.inceTypes.push(data.inces[i].inceType),$scope.config.mediTypes[data.inces[i].inceType]=[],slideIndex[data.inces[i].inceType]=i;for(var j=0;j<data.inces[i].amountDetails.length;j++)$scope.config.mediTypes[data.inces[i].inceType].push(data.inces[i].amountDetails[j]);inces[data.inces[i].inceType]={incePolicyId:data.inces[i]._id,unitId:data.inces[i].unitId._id,inceId:data.inces[i].inceId._id,servId:data.inces[i].servId._id,inceGenNum:data.inces[i].inceGenNum}}$scope.cons={employeeId:data.user.personalInfo.employeeId,consumer:{relation:"本人",idType:"身份证"},visitDate:{start:new Date(Date.now()-864e5),end:new Date},status:{isSubmitted:!1,isRevoked:!1,isAudited:!1},consType:"self",money:12,outName:"浙江大学医院",unitType:"pub",note:"我要申请理赔",ownPay:6,receiptTotalAmount:2},(!data.user.personalInfo.idImg||data.user.personalInfo.idImg.length<$scope.config.images.length)&&$scope.actions.chgIdImg(),$scope.$broadcast("scroll.refreshComplete")},function(err){console.log(err),$scope.$broadcast("scroll.refreshComplete")})},chgIdImg:function(){$scope.config.title="拍摄证件照片",$scope.takePicsModal?$scope.takePicsModal.show():User.takePicsModal($scope,$scope.accountInfo.user.personalInfo.idImg)},chgIdNo:function(idNo){return idNo?void PageFunc.prompt("登录密码","请输入密码查看身份证").then(function(res){res&&User.verifyPwd(res).then(function(data){"OK"===data.results?PageFunc.message("身份证号码: "+idNo+', 如有错误, 请联系服务专员修改!<br><a ng-href="tel:'+CONFIG.serv400.number+'">'+CONFIG.serv400.caption+"</a>"):$ionicLoading.show({template:"<span>密码错误</span>",duration:800})},function(err){$ionicLoading.show({template:"<span>密码错误</span>",duration:800}),console.log(err.data)})}):void PageFunc.prompt("登录密码","请输入密码设置身份证").then(function(res){res&&User.verifyPwd(res).then(function(data){"OK"===data.results?($scope.config.title="设置身份证",$scope.data.key="personalInfo.idNo",$scope.data.value=idNo,$scope.actions.show()):$ionicLoading.show({template:"<span>密码错误</span>",duration:1500})},function(err){$ionicLoading.show({template:"<span>密码错误</span>",duration:1500}),console.log(err.data)})})},chgInceType:function(type){$scope.config.curMediTypes=$scope.config.mediTypes[type],$scope.cons.incePolicyId=inces[type].incePolicyId,$scope.cons.unitId=inces[type].unitId,$scope.cons.inceId=inces[type].inceId,$scope.cons.servId=inces[type].servId,$scope.cons.inceGenNum=inces[type].inceGenNum;var index=slideIndex[type];$ionicSlideBoxDelegate.$getByHandle("inceType").slide(index,800)}},User.updateModal($scope),$scope.$on("$ionicView.beforeEnter",function(){$scope.actions.doRefresh()})}]).controller("userConsList",["$scope","$q","$ionicPopover","Consumption","PageFunc","$cordovaBarcodeScanner","$ionicHistory","Storage","$stateParams","$ionicHistory","$ionicListDelegate",function($scope,$q,$ionicPopover,Consumption,PageFunc,$cordovaBarcodeScanner,$ionicHistory,Storage,$stateParams,$ionicHistory,$ionicListDelegate){var batch=null,lastTime=null,consList=[],init=function(){var deferred=$q.defer();return Consumption.getList(null,{skip:0,limit:batch}).then(function(data){consList=data.results,$scope.items=consList.filter(function(item){return!item.status.isSubmitted&&!item.status.isAudited&&!item.status.isRevoked&&!item.status.isDone||item.status.isSubmitted&&!item.status.isAudited&&!item.status.isRevoked&&!item.status.isDone&&$scope.filters.checkBoxItems[0].checked===!0||item.status.isAudited&&!item.status.isDone&&$scope.filters.checkBoxItems[1].checked===!0||item.status.isRevoked&&$scope.filters.checkBoxItems[2].checked===!0||item.status.isDone&&$scope.filters.checkBoxItems[3].checked===!0?(item.receiptImg&&item.receiptImg[0]&&(item.receiptImgUrl=item.receiptImg[0].Url.replace(/\/([^\/]+?\.[^\/]+?)$/,"/thumb/sm_$1")),!0):void 0}),lastTime=Date.now(),deferred.resolve()},function(err){console.log(err.data),deferred.reject()}),deferred.promise};$scope.$on("$ionicView.beforeEnter",function(){var thisMoment=Date.now();(thisMoment-lastTime)/36e5>1&&init(),$stateParams.action&&$scope.actions[$stateParams.action]()}),$scope.filters={title:"消费记录筛选",isCheckBox:!0,checkBoxItems:[{text:"已提交",checked:!0},{text:"已审核",checked:!1},{text:"已核销",checked:!1},{text:"已完成",checked:!1}],height:"280px"},$ionicPopover.fromTemplateUrl("partials/popover/filter.html",{scope:$scope}).then(function(popover){$scope.filterPopover=popover}),$scope.$on("$destroy",function(){$scope.filterPopover.remove()}),$scope.actions={doRefresh:function(){init()["catch"](function(err){console.log(err)})["finally"](function(){$scope.$broadcast("scroll.refreshComplete")})},showFilter:function($event){$scope.filterPopover.show($event)},closeFilter:function(){$scope.filterPopover.hide()},filterItems:function(){$scope.items=consList.filter(function(item){return!item.status.isSubmitted&&!item.status.isAudited&&!item.status.isRevoked&&!item.status.isDone||item.status.isSubmitted&&!item.status.isAudited&&!item.status.isRevoked&&!item.status.isDone&&$scope.filters.checkBoxItems[0].checked===!0||item.status.isAudited&&!item.status.isDone&&$scope.filters.checkBoxItems[1].checked===!0||item.status.isRevoked&&$scope.filters.checkBoxItems[2].checked===!0||item.status.isDone&&$scope.filters.checkBoxItems[3].checked===!0?(item.receiptImg&&item.receiptImg[0]&&(item.receiptImgUrl=item.receiptImg[0].Url.replace(/\/([^\/]+?\.[^\/]+?)$/,"/thumb/sm_$1")),!0):void 0})},scan:function(event){return window.cordova&&window.cordova.plugins&&window.cordova.plugins.barcodeScanner?void $cordovaBarcodeScanner.scan().then(function(result){return result.cancelled?($ionicHistory.goBack(0),console.log("用户取消!")):void Consumption.getOne({_id:result.text}).then(function(data){var cons=data.results;$scope.items=consList.filter(function(item){return item._id===cons._id?cons.status.isRevoked===!0?PageFunc.message("申请已退回!",2e3):cons.status.isDone===!0?PageFunc.message("申请已通过!",2e3):!0:void 0}),0===$scope.items.length&&PageFunc.message("理赔申请不存在!",2e3)},function(err){PageFunc.message("理赔申请不存在!",2e3)})},function(err){PageFunc.message("扫码错误!",2e3)}):PageFunc.message("不支持扫码!",2e3)},revokeItem:function(item,$index,event){PageFunc.confirm("是否确认撤销理赔申请?","撤销").then(function(res){res&&Consumption.updateOne({_id:item._id,set:"revoke"}).then(function(data){item.status.isRevoked=data.results.cons.status.isRevoked,$ionicListDelegate.closeOptionButtons()},function(err){$scope.error.receiptError=err.data,console.log(err.data)})})}}}]).controller("userConsDetail",["$q","$scope","$state","$stateParams","$cordovaCamera","$cordovaFileTransfer","$timeout","$ionicLoading","PageFunc","Consumption","CONFIG","Storage","$ionicScrollDelegate",function($q,$scope,$state,$stateParams,$cordovaCamera,$cordovaFileTransfer,$timeout,$ionicLoading,PageFunc,Consumption,CONFIG,Storage,$ionicScrollDelegate){$scope.error={},$scope.input={};var cameraOptions=CONFIG.cameraOptions,uploadOptions=CONFIG.uploadOptions;$scope.pageHandler={progress:0,showDelete:!1},$scope.actions={showDelete:function(){$scope.pageHandler.showDelete=!$scope.pageHandler.showDelete},deleteImg:function(img,$index){PageFunc.confirm("是否确认删除?","删除图片").then(function(res){res&&(Consumption.updateOne({_id:$stateParams.consId,pull:{Url:img.Url,path:img.path,title:img.title,type:img.type,No:img.No}}).then(function(data){},function(err){$scope.error.receiptError=err.data,console.log(err.data)}),item.receiptImg.splice($index,1),item.receiptImgThumb.splice($index,1))})},takePic:function(type){if(!window.navigator||!window.navigator.camera)return console.log("不支持window.navigator.camera");var deferred=$q.defer();"recpt"===type?PageFunc.prompt("请输入单据号","单据号","text").then(function(res){return res?deferred.resolve(res):void deferred.reject("必须输入发票号")}):deferred.resolve(),$q.all([deferred.promise]).then(function(res){$cordovaCamera.getPicture(cameraOptions).then(function(imageURI){$timeout(function(){var serverUrl=encodeURI(CONFIG.baseUrl+CONFIG.consReceiptUploadPath);uploadOptions.headers={Authorization:"Bearer "+Storage.get("token")},uploadOptions.fileName=$stateParams.consId+CONFIG.uploadOptions.fileExt,uploadOptions.params={_id:$stateParams.consId,No:res[0]||void 0,type:type},PageFunc.confirm("是否上传?","上传图片").then(function(res){if(res)return $ionicLoading.show({template:'<ion-spinner style="height:2em;width:2em"></ion-spinner>'}),window.FileTransfer?$cordovaFileTransfer.upload(serverUrl,imageURI,uploadOptions,!0).then(function(result){$scope.pageHandler.progress=0,$ionicLoading.hide(),$scope.error.receiptError="上传成功!",$scope.item.receiptImg=JSON.parse(result.response).results.receiptImg,$scope.item.receiptImgThumb=$scope.item.receiptImg.filter(function(img){return img&&(img.urlThumb=img.Url.replace(/\/([^\/]+?\.[^\/]+?)$/,"/thumb/$1")),!0});try{$cordovaCamera.cleanup().then(function(){},function(err){console.log(err)})}catch(e){console.log(e)}},function(err){console.log(err),$scope.error.receiptError=err,$scope.pageHandler.progress=0,$ionicLoading.hide();try{$cordovaCamera.cleanup().then(function(){},function(err){console.log(err)})}catch(e){console.log(e)}},function(progress){$scope.pageHandler.progress=progress.loaded/progress.total*100}):($ionicLoading.hide(),console.log("不支持window.FileTransfer"));$scope.pageHandler.progress=0,$scope.error.receiptError="取消上传!";try{$cordovaCamera.cleanup().then(function(){},function(err){console.log(err)})}catch(e){console.log(e)}})},0)},function(err){$scope.error.receiptError=err,console.log(err)})},function(err){$ionicLoading.show({template:"<span>"+err+"</span>",duration:800})})},submit:function(){PageFunc.confirm("是否提交?","提交记录").then(function(res){return res?Consumption.updateOne({_id:$stateParams.consId,set:"submit"}).then(function(data){$scope.item=data.results,$scope.item.receiptImgThumb=$scope.item.receiptImg.filter(function(img){return img&&(img.urlThumb=img.Url.replace(/\/([^\/]+?\.[^\/]+?)$/,"/thumb/$1")),!0}),$scope.error.receiptError="提交成功!"},function(err){$scope.error.receiptError=err.data,console.log(err.data)}):void 0})},doRefresh:function(){init(!0)["catch"](function(err){console.log(err)})["finally"](function(){$scope.$broadcast("scroll.refreshComplete")})},viewer:function($index,group){var images=group&&$scope.item.userId.personalInfo.idImg||$scope.item.receiptImg;PageFunc.viewer($scope,images,$index)},revokeItem:function(item){PageFunc.confirm("是否确认撤销理赔申请?","撤销").then(function(res){res&&Consumption.updateOne({_id:item._id,set:"revoke"}).then(function(data){item.status.isRevoked=data.results.cons.status.isRevoked},function(err){$scope.error.receiptError=err.data,console.log(err.data)})})},ask:function(){var comment={_id:$scope.item._id,content:$scope.input.message};Consumption.comment(comment).then(function(data){$scope.item.comments=data.results,$scope.input.message="",$ionicScrollDelegate.scrollBottom()},function(err){console.log(err)})}};var init=function(refresh){var deferred=$q.defer();return Consumption.getOne({_id:$stateParams.consId}).then(function(data){$scope.item=data.results,$scope.item.btnSubmitActive=data.results.mediType.photoSet.length===data.results.receiptImg.length,console.log($scope.item.btnSubmitActive),$scope.item.receiptImgThumb=$scope.item.receiptImg.filter(function(img){return img&&(img.urlThumb=img.Url.replace(/\/([^\/]+?\.[^\/]+?)$/,"/thumb/$1")),!0}),$scope.item.idImgThumb=$scope.item.userId.personalInfo.idImg.filter(function(img){return img&&(img.urlThumb=img.Url.replace(/\/([^\/]+?\.[^\/]+?)$/,"/thumb/$1")),!0}),deferred.resolve()},function(err){deferred.reject(),console.log(err.data)}),deferred.promise};init(),console.log($scope.item),$scope.$on("$ionicView.afterEnter",function(){$stateParams.conf&&($scope.conf=$stateParams.conf)})}]).controller("userActivities",["$scope",function($scope){}]).controller("userAround",["$scope","$timeout",function($scope,$timeout){
$scope.mapOptions={scaleCtrl:!1,zoom:12}}]).controller("userMine",["$scope","$ionicPopup","$q","$ionicActionSheet","$cordovaCamera","$cordovaFileTransfer","Storage","User","$timeout","PageFunc","CONFIG","Token","$stateParams",function($scope,$ionicPopup,$q,$ionicActionSheet,$cordovaCamera,$cordovaFileTransfer,Storage,User,$timeout,PageFunc,CONFIG,Token,$stateParams){$scope.config={genders:CONFIG.genders,q1:CONFIG.q1,q2:CONFIG.q2,q3:CONFIG.q3,images:[{title:"身份证正面"},{title:"身份证反面"},{title:"病历首页"},{title:"银行卡"}]},$scope.pageHandler={progress:0},$scope.data={};var cameraOptions=angular.copy(CONFIG.cameraOptions),uploadOptions=angular.copy(CONFIG.uploadOptions);User.initAccInfo($scope),$scope.actions={doRefresh:function(){User.initAccInfo($scope)["catch"](function(err){console.log(err)})["finally"](function(){$scope.$broadcast("scroll.refreshComplete")})},chgHead:function(){$ionicActionSheet.show({buttons:[{text:"<b>拍摄头像</b>"},{text:"相册照片"}],titleText:"设置头像",cancelText:"取消",cancel:function(){},buttonClicked:function(index){switch(cameraOptions.allowEdit=!0,cameraOptions.targetWidth=800,cameraOptions.targetHeight=800,cameraOptions.cameraDirection=1,index){case 0:cameraOptions.sourceType=1;break;case 1:cameraOptions.sourceType=2}return window.navigator&&window.navigator.camera?($cordovaCamera.getPicture(cameraOptions).then(function(imageURI){$timeout(function(){var serverUrl=encodeURI(CONFIG.baseUrl+CONFIG.userResUploadPath);uploadOptions.headers={Authorization:"Bearer "+Storage.get("token")},uploadOptions.fileName="userHead"+CONFIG.uploadOptions.fileExt,uploadOptions.params={method:"$set",dest:"head",replace:!0},PageFunc.confirm("是否上传?","上传头像").then(function(res){if(res)return window.FileTransfer?$cordovaFileTransfer.upload(serverUrl,imageURI,uploadOptions,!0).then(function(result){$scope.pageHandler.progress=0,$scope.accountInfo.user.head={Url:JSON.parse(result.response).results.Url};try{$cordovaCamera.cleanup().then(function(){console.log("Camera cleanup success.")},function(err){console.log(err)})}catch(e){console.log(e)}},function(err){console.log(err),$scope.error.headError=err,$scope.pageHandler.progress=0;try{$cordovaCamera.cleanup().then(function(){console.log("Camera cleanup success.")},function(err){console.log(err)})}catch(e){console.log(e)}},function(progress){$scope.pageHandler.progress=progress.loaded/progress.total*100}):console.log("不支持window.fileTransfer");$scope.pageHandler.progress=0,$scope.error.headError="取消上传!";try{$cordovaCamera.cleanup().then(function(){console.log("Camera cleanup success.")},function(err){console.log(err)})}catch(e){console.log(e)}})},0)},function(err){$scope.error.headError=err,console.log(err)}),!0):console.log("不支持window.navigator.camera")}})},chgUsername:function(){$scope.accountInfo.user.username===$scope.accountInfo.user.personalInfo.idNo&&($scope.config.title="修改用户名",$scope.data.key="username",$scope.data.value=$scope.accountInfo.user.username,$scope.actions.show())},chgMobile:function(){var smsType,title,msg;$scope.accountInfo.user.mobile?(smsType="-chgBind",title="修改手机号",msg="请输入当前绑定手机号"):(smsType="-initBind",title="绑定手机号",msg="请输入手机号"),$scope.bindMobileModal?$scope.bindMobileModal.show():User.bindMobileModal(Token.curUserRole(),smsType,$scope.accountInfo.user.mobile,title,msg,!0)},chgEmail:function(){$scope.config.title="修改邮箱地址",$scope.data.key="email",$scope.data.value=$scope.accountInfo.user.email,$scope.actions.show()},chgAccountNo:function(){$scope.config.title="修改银行卡号",$scope.data.key="extInfo.yiyangbaoHealInce.accountNo",$scope.data.value=$scope.accountInfo.user.extInfo.yiyangbaoHealInce.accountNo,$scope.actions.show()},chgPwd:function(){$scope.passwordModal?$scope.passwordModal.show():User.passwordModal($scope)},chgPwdQst:function(){PageFunc.prompt("登录密码","请输入登录密码").then(function(res){res&&User.verifyPwd(res).then(function(data){"OK"===data.results&&($scope.config.title="设置密保问题",$scope.pwdQstModal?$scope.pwdQstModal.show():User.pwdQstModal($scope))},function(err){console.log(err.data)})})},chgDealPwd:function(){$scope.dealPasswordModal?$scope.dealPasswordModal.show():User.dealPasswordModal($scope,$scope.accountInfo.user.extInfo.yiyangbaoHealInce.dealPassword,!0)},chgName:function(){$scope.config.title="修改姓名",$scope.data.key="personalInfo.name",$scope.data.value=$scope.accountInfo.user.personalInfo.name,$scope.actions.show()},chgGender:function(gender){User.updateOne({"personalInfo.gender":gender}).then(function(data){},function(err){console.log(err.data)})},chgBirthdate:function(birthdate){return birthdate?void User.updateOne({"personalInfo.birthdate":birthdate}).then(function(data){},function(err){console.log(err.data)}):($scope.accountInfo.user.personalInfo.birthdate=new Date(JSON.parse(Storage.get("AccInfo")).user.personalInfo.birthdate),PageFunc.message("生日不能为空!"))},chgIdNo:function(){PageFunc.message('如有错误, 请联系服务专员修改!<br><a ng-href="tel:'+CONFIG.serv400.number+'">'+CONFIG.serv400.caption+"</a>")},chgLocation:function(){$scope.config.title="修改地址",$scope.data.key="personalInfo.location.city.name",$scope.data.value=$scope.accountInfo.user.personalInfo.location&&$scope.accountInfo.user.personalInfo.location.city&&$scope.accountInfo.user.personalInfo.location.city.name,$scope.actions.show()},chgIdImg:function(){$scope.config.title="拍摄证件照片",$scope.takePicsModal?$scope.takePicsModal.show():User.takePicsModal($scope,$scope.accountInfo.user.personalInfo.idImg)}},$scope.$on("$ionicView.loaded",function(){User.updateModal($scope)})}]).controller("userHelper",["$scope",function($scope){}]).controller("userSettings",["$scope","$ionicPopup","$q","Storage","User",function($scope,$ionicPopup,$q,Storage,User){User.initAccInfo($scope),$scope.actions={doRefresh:function(){User.initAccInfo($scope)["catch"](function(err){console.log(err)})["finally"](function(){$scope.$broadcast("scroll.refreshComplete")})},clearCache:function(){var token=Storage.get("token")||"",refreshToken=Storage.get("refreshToken")||"",myAppVersionLocal=Storage.get("myAppVersion")||"";Storage.clear(),token&&Storage.set("token",token),refreshToken&&Storage.set("refreshToken",refreshToken),myAppVersionLocal&&Storage.set("myAppVersion",myAppVersionLocal),$ionicPopup.alert({title:"缓存",template:"<h4><b>清理成功</b></h4>"})},logout:function(){User.logout($scope)}}}]).controller("userFeedback",["$scope",function($scope){}]).controller("userSearch",["$scope",function($scope){}]).controller("userHealth",["$scope",function($scope){}]).controller("userOnlinecart",["$scope",function($scope){}]).controller("userKenbei",["$scope",function($scope){}]).controller("userBxproduct",["$scope",function($scope){}]).controller("userMyguang",["$scope",function($scope){}]).controller("userYangsheng",["$scope",function($scope){}]).controller("userArticle",function($scope,$stateParams){console.log($stateParams.typeid,$stateParams.id);var articles=["健康管理","线上药店","健康商城","保险产品","名医馆","名家养生"],article=$scope.article={};article.catname=articles[$stateParams.typeid],article.title="杭州颐养网络科技有限公司"}),angular.module("yiyangbao.directives",[]).directive("buttonClearInput",function(){return{restrict:"AE",scope:{input:"="},template:"<button ng-if='input' class='button button-icon ion-android-close input-button' type='button' ng-click='clearInput()'></button>",controller:function($scope,$element,$attrs){$scope.clearInput=function(){$scope.input=""}}}}).directive("barcodeX",["$cordovaBarcodeScanner","$ionicPlatform","$ionicHistory","barcodeXs","Token","PageFunc",function($cordovaBarcodeScanner,$ionicPlatform,$ionicHistory,barcodeXs,Token,PageFunc){return{restrict:"AE",replace:!0,template:'<a class="button button-icon icon ion-ios-barcode-outline" on-touch="barcodeX.scan($event)"></a>',controller:function($scope,$element,$attrs){var func=$attrs.func,role=Token.curUserRole();$scope.barcodeX={scan:function(event){return window.cordova&&window.cordova.plugins&&window.cordova.plugins.barcodeScanner?void $cordovaBarcodeScanner.scan().then(function(result){return result.cancelled?($ionicHistory.goBack(0),console.log("用户取消!")):void barcodeXs.routes(result.text,role,func)},function(err){return console.log(err),PageFunc.message(err,1e3)}):PageFunc.message("不支持扫码插件!",1e3)}}}}}]).directive("imageonload",function(){return{restrict:"A",link:function(scope,element,attrs){element.bind("load",function(){scope.$apply(attrs.imageonload)}),element.bind("error",function(){scope.$apply(attrs.imagefailure)})}}}),angular.module("yiyangbao.filters",[]).filter("mapGender",function(){var genderHash={1:"男",2:"女",3:"未知",4:"未申明",5:"其他","男":"男","女":"女",male:"男",female:"女"};return function(input){return input?genderHash[input]||"未知":"未知"}}).filter("mapTitle",function(){var genderHash={1:"先生",2:"女士"};return function(input){return input?genderHash[input]||"用户":"用户"}}).filter("maskMobile",function(){return function(input){return input?input.replace(/^(.{3}).{4}(.{4})/,"$1*****$2"):null}}).filter("maskEmail",function(){return function(input){return input?input.replace(/^(.{1}).*?(@.+)$/,"$1**$2"):null}}).filter("maskIdNo",function(){return function(input){return input?input.replace(/^(.{6}).*(.{1})$/,"$1***********$2"):null}}).filter("mapMediType",function(){var mediTypeHash={out:"门诊","in":"住院"};return function(input){return input?mediTypeHash[input]||"门诊":"门诊"}}).filter("mapUnitType",function(){var hash={pub:"国有企业",priv:"私营企业"};return function(input){return input?hash[input]||"私营企业":"私营企业"}}).filter("mapInceType",function(){var hash={welf:"补充医保",commer:"商业保险"};return function(input){return input?hash[input]||"商业保险":"商业保险"}}).filter("mapInceTypeText",function(){var hash={5:"医疗金保险"};return function(input){return input?hash[input]||"医疗金保险":"医疗金保险"}}).filter("mapRecptType",function(){var hash={emrec:"病历页",recpt:"发票",pharm:"用药清单",disch:"出院小结"};return function(input){return input?hash[input]||"其他":"其他"}}).filter("recptImgLen",function(){return function(input,type){return input.filter(function(img){return img.type===type}).length}}),angular.module("yiyangbao.services",["ngResource"]).constant("CONFIG",{baseUrl:"http://app.xiaoyangbao.net/",ioDefaultNamespace:"app.xiaoyangbao.net/default",consReceiptUploadPath:"cons/receiptUpload",userResUploadPath:"user/resUpload",cameraOptions:{quality:20,destinationType:1,sourceType:1,encodingType:0,correctOrientation:!0,saveToPhotoAlbum:!1,cameraDirection:0},uploadOptions:{fileExt:".jpg",httpMethod:"POST",mimeType:"image/jpg"},showTime:500,userRoles:["public","user","serv","unit","medi","ince","admin","super"],accessLevels:{"public":"*",anon:["public"],user:["user","admin","super"],serv:["serv","super"],unit:["unit","super"],medi:["medi","super"],ince:["ince","super"],admin:["admin","super"]},genders:[1,2],q1:["父亲名字","母亲名字","配偶名字","小孩名字","父亲生日","母亲生日","配偶生日","小孩生日"],q2:["最喜欢的颜色","小学名称","初中名称","高中名称","大学的专业","最喜欢的演员"],q3:["最喜欢的歌曲","第一只宠物的名字","最喜欢的水果","最喜欢的食物","最喜欢的宠物"],serv400:{number:"4008006666",caption:"4008-006-666"}}).factory("Storage",["$window",function($window){return{set:function(key,value){$window.localStorage.setItem(key,value)},get:function(key){return $window.localStorage.getItem(key)},rm:function(key){$window.localStorage.removeItem(key)},clear:function(){$window.localStorage.clear()}}}]).factory("Token",["Storage","jwtHelper","ACL",function(Storage,jwtHelper,ACL){return{curUserRole:function(){var userRole=ACL.userRoles["public"].title;try{userRole=jwtHelper.decodeToken(Storage.get("token")).userRole}catch(e){return ACL.userRoles["public"].title}return userRole},isExpired:function(){var isExpired=!0;try{isExpired=jwtHelper.isTokenExpired(Storage.get("token"))}catch(e){return!0}return isExpired}}}]).factory("Data",["$resource","$q","CONFIG","$interval",function($resource,$q,CONFIG,$interval){var self=this,abort=$q.defer(),User=function(){return $resource(CONFIG.baseUrl+":path/:route",{path:"user"},{verifyPwd:{method:"POST",params:{route:"verifyPwd"},timeout:1e4},verifyUser:{method:"POST",params:{route:"verifyUser"},timeout:1e4},login:{method:"POST",params:{route:"login"},timeout:1e4},getList:{method:"POST",params:{route:"getList"},timeout:abort.promise},getInfo:{method:"GET",params:{route:"getInfo"},timeout:1e4},getAccInfo:{method:"GET",params:{route:"getAccInfo"},timeout:1e4},updateOne:{method:"POST",params:{route:"updateOne"},timeout:1e4},bindBarcode:{method:"POST",params:{route:"bindBarcode"},timeout:1e4},barCodePay:{method:"POST",params:{route:"barCodePay"},timeout:1e4},updateOnesPwd:{method:"POST",params:{route:"updateOnesPwd"},timeout:1e4},updateOneWithSMS:{method:"POST",params:{route:"updateOneWithSMS"},timeout:1e4},logout:{method:"GET",params:{route:"logout"},timeout:1e4}})},Insurance=function(){return $resource(CONFIG.baseUrl+":path/:route",{path:"ince"},{getInfo:{method:"POST",params:{route:"getInfo"},timeout:1e4},getList:{method:"POST",params:{route:"getList"},timeout:abort.promise},modify:{method:"POST",params:{route:"modify"},timeout:1e4},remove:{method:"POST",params:{route:"remove"},timeout:1e4},removeOne:{method:"GET",params:{route:"removeOne"},timeout:1e4}})},Consumption=function(){return $resource(CONFIG.baseUrl+":path/:route",{path:"cons"},{insertOne:{method:"POST",params:{route:"insertOne"},timeout:1e4},applyOne:{method:"POST",params:{route:"applyOne"},timeout:1e4},getOne:{method:"POST",params:{route:"getOne"},timeout:1e4},getList:{method:"POST",params:{route:"getList"},timeout:abort.promise},updateOne:{method:"POST",params:{route:"updateOne"},timeout:1e4},comment:{method:"POST",params:{route:"comment"},timeout:1e4},revoking:{method:"POST",params:{route:"revoking"},timeout:1e4}})},Post=function(){return $resource(CONFIG.baseUrl+":path/:route",{path:"post"},{post:{method:"POST",params:{route:"post"},timeout:1e4},getList:{method:"POST",params:{route:"getList"},timeout:abort.promise},modify:{method:"POST",params:{route:"modify"},timeout:1e4},updateOne:{method:"POST",params:{route:"updateOne"},timeout:1e4},removeOne:{method:"GET",params:{route:"removeOne"},timeout:1e4}})},Resource=function(){return $resource(CONFIG.baseUrl+":path/:route",{path:"multer"},{rmBrokenFile:{method:"GET",params:{route:"upload"},timeout:1e4}})},Interface=function(){return $resource(CONFIG.baseUrl+":path/:route",{path:"interface"},{smsSend:{method:"POST",params:{route:"smsSend"},timeout:1e4},captchaImg:{method:"GET",params:{route:"captchaImg"},timeout:1e4}})};return self.abort=function($scope){abort.resolve(),$interval(function(){abort=$q.defer(),self.User=User(),self.Insurance=Insurance(),self.Consumption=Consumption(),self.Post=Post(),self.Resource=Resource(),self.Interface=Interface()},0,1)},self.User=User(),self.Insurance=Insurance(),self.Consumption=Consumption(),self.Post=Post(),self.Resource=Resource(),self.Interface=Interface(),self}]).factory("Socket",["socketFactory","CONFIG",function(socketFactory,CONFIG){var self=this,ioSocket=io.connect(CONFIG.baseUrl+CONFIG.ioDefaultNamespace);return self["default"]=socketFactory({ioSocket:ioSocket}),self["new"]=function(){ioSocket=io.connect(CONFIG.baseUrl+CONFIG.ioDefaultNamespace),console.log(CONFIG.baseUrl+CONFIG.ioDefaultNamespace),self["default"]=socketFactory({ioSocket:ioSocket})},self.getSocket=function(){return ioSocket},self}]).factory("User",["$rootScope","PageFunc","$ionicLoading","$ionicActionSheet","$cordovaCamera","$cordovaFileTransfer","CONFIG","$timeout","Storage","Data","Token","$state","$ionicHistory","$ionicModal","$q","$ionicSlideBoxDelegate","jwtHelper","$http","$interval",function($rootScope,PageFunc,$ionicLoading,$ionicActionSheet,$cordovaCamera,$cordovaFileTransfer,CONFIG,$timeout,Storage,Data,Token,$state,$ionicHistory,$ionicModal,$q,$ionicSlideBoxDelegate,jwtHelper,$http,$interval){var self=this;return self.verifyPwd=function(pwd){var deferred=$q.defer();return Data.User.verifyPwd({password:pwd},function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},self.verifyUser=function(user,pwdQst){var deferred=$q.defer();return Data.User.verifyUser({user:user,pwdQst:pwdQst},function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},self.login=function($scope){$ionicLoading.show({template:'<ion-spinner style="height:2em;width:2em"></ion-spinner>'}),Data.User.login($scope.login,function(data,headers){$scope.error.loginError="",$ionicLoading.hide();var userRole=jwtHelper.decodeToken(data.results.token).userRole;Storage.set("token",data.results.token),$scope.login.rememberme?Storage.set("refreshToken",data.results.refreshToken):Storage.rm("refreshToken"),data.results.justActivated&&self.bindMobileModal(userRole,"-initBind"),$scope.loginModal&&$scope.loginModal.remove().then(function(){$scope.loginModal=null}),$scope.registerModal&&$scope.registerModal.remove().then(function(){$scope.registerModal=null}),$scope.pwdResetModal&&$scope.pwdResetModal.remove().then(function(){$scope.pwdResetModal=null});var toStateName="medi"===userRole&&"medi.home"||"serv"===userRole&&"serv.home"||"user"===userRole&&"user.home"||"public.aboutUs";$state.go($scope.state.toStateName||toStateName)},function(err){var myAppVersionLocal=Storage.get("myAppVersion")||"";Storage.clear(),myAppVersionLocal&&Storage.set("myAppVersion",myAppVersionLocal),$ionicLoading.hide(),$scope.error.loginError=err.data||"连接超时!"})},self.getInfo=function(token,options,fields){var deferred=$q.defer();return Data.User.getInfo({token:token},function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},self.getAccInfo=function(token,options,fields){var deferred=$q.defer();return Data.User.getAccInfo({token:token},function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},self.bindBarcode=function(barcode){var deferred=$q.defer();return Data.User.bindBarcode(barcode,function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},self.barCodePay=function(barcode){var deferred=$q.defer();return Data.User.barCodePay(barcode,function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},self.updateOne=function(user,options){var deferred=$q.defer();return Data.User.updateOne({user:user,options:options},function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},self.updateOneWithSMS=function(user,options){var deferred=$q.defer();return Data.User.updateOneWithSMS(user,function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},self.updateOnesPwd=function(user,options){var deferred=$q.defer();return Data.User.updateOnesPwd(user,function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},self.logout=function($scope){$ionicActionSheet.show({buttons:[{text:'<b class="assertive">确认退出</b>'}],titleText:"确认退出账号吗?",cancelText:"取消",cancel:function(){},buttonClicked:function(index){if(0===index){var refreshToken=Storage.get("refreshToken")&&{refreshToken:Storage.get("refreshToken")}||{};Data.User.logout(refreshToken,function(data,headers){},function(err){});var myAppVersionLocal=Storage.get("myAppVersion")||"";Storage.clear(),myAppVersionLocal&&Storage.set("myAppVersion",myAppVersionLocal),$ionicHistory.clearHistory(),$ionicHistory.clearCache(),$state.go("public.aboutUs")}}})},self.loginModal=function($scope){$ionicModal.fromTemplateUrl("partials/modal/login.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.loginModal=modal,$scope.loginModal.show(),self.pwdResetModal($scope)}),$scope.actions=$scope.actions||{},$scope.error=$scope.error||{},$scope.actions.closeLogin=function(){$scope.loginModal.hide()},$scope.actions.showLogin=function(){$scope.loginModal.show()},$scope.actions.preRegister=function(){$scope.actions.closeLogin(),$scope.actions.showRegister()},$scope.actions.prePwdReset=function(){$scope.actions.closeLogin(),$scope.actions.showPwdReset()},$scope.actions.login=function(){self.login($scope)},$scope.login={username:"1",password:"a",rememberme:!0}},self.registerModal=function($scope){$ionicModal.fromTemplateUrl("partials/modal/register.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.registerModal=modal}),$scope.actions.closeRegister=function(){$scope.registerModal.hide()},$scope.actions.showRegister=function(){$scope.registerModal.show()},$scope.actions.preLoginR=function(){$scope.actions.closeRegister(),$scope.actions.showLogin()},$scope.actions.register=function(){self.register($scope.register).then(function(data){$scope.error.registerError="",Storage.set("token",data.results.token),$scope.loginModal&&$scope.loginModal.remove().then(function(){$scope.loginModal=null}),$scope.pwdResetModal&&$scope.pwdResetModal.remove().then(function(){$scope.pwdResetModal=null}),$scope.registerModal.remove().then(function(){$scope.registerModal=null}),$state.go($scope.state.toStateName||"user.home")},function(err){var myAppVersionLocal=Storage.get("myAppVersion")||"";Storage.clear(),myAppVersionLocal&&Storage.set("myAppVersion",myAppVersionLocal),$scope.error.registerError=err.data})},$scope.register={username:"z",mobile:"13282037883",password:"a",repeatPassword:"a",name:"周天才",gender:!0,rememberme:!1}},self.pwdResetModal=function($scope){$ionicModal.fromTemplateUrl("partials/modal/pwdReset.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.pwdResetModal=modal}),$scope.data={},!$scope.loginModal&&$scope.accountInfo&&$scope.accountInfo.user.username&&($scope.data.value=$scope.accountInfo.user.username),$scope.password={},$scope.config=$scope.config||{},$scope.config.serv400=CONFIG.serv400,$scope.currentIndex=0,$scope.error.pwdResetError="";var token;$scope.actions.closePwdReset=function(){$scope.pwdResetModal.hide()},$scope.actions.showPwdReset=function(){$scope.pwdResetModal.show(),$timeout(function(){$scope.slidesCount=$ionicSlideBoxDelegate.$getByHandle("pwdReset").slidesCount(),$ionicSlideBoxDelegate.$getByHandle("pwdReset").enableSlide(!1),$ionicSlideBoxDelegate.$getByHandle("pwdReset").update()})},$scope.actions.preLoginP=function(){$scope.actions.closePwdReset(),$scope.loginModal?$scope.actions.showLogin():$scope.pwdResetModal.remove().then(function(){$scope.pwdResetModal=null})},$scope.actions.previous=function(){$ionicSlideBoxDelegate.$getByHandle("pwdReset").previous()},$scope.actions.getIndex=function(){$scope.currentIndex=$ionicSlideBoxDelegate.$getByHandle("pwdReset").currentIndex(),$scope.error.pwdResetError=""},$scope.actions.verifyUser=function(){return $scope.data.value?void self.verifyUser($scope.data.value).then(function(data){$scope.pwdQst=data.results,$scope.error.pwdResetError="",$ionicSlideBoxDelegate.$getByHandle("pwdReset").next()},function(err){$scope.error.pwdResetError=err.data}):void($scope.error.pwdResetError="请输入正确信息!")},$scope.actions.verifyUserSMS=function(){var mobile,smsType="-findPwd",title="找回登录密码",msg="请输入手机号";!$scope.loginModal&&$scope.accountInfo&&$scope.accountInfo.user.username&&(smsType="-findDealPwd",title="找回支付密码",mobile=$scope.accountInfo.user.mobile),$scope.bindMobileModal?$scope.bindMobileModal.show():self.bindMobileModal(Token.curUserRole(),smsType,mobile,title,msg,!0),$scope.actions.preLoginP()},$scope.actions.pwdInput=function(){return $scope.pwdQst[0].a&&$scope.pwdQst[1].a&&$scope.pwdQst[2].a?void self.verifyUser($scope.data.value,$scope.pwdQst).then(function(data){token=data.results,$scope.error.pwdResetError="",$ionicSlideBoxDelegate.$getByHandle("pwdReset").next()},function(err){$scope.error.pwdResetError=err.data}):void($scope.error.pwdResetError="未回答所有密保问题!")},$scope.actions.pwdReset=function(){return $scope.password.newPassword&&$scope.password.repeatPwd?$scope.password.newPassword!==$scope.password.repeatPwd?void($scope.error.pwdResetError="两次输入不一致!"):token?($scope.password.token=token,$scope.loginModal?$scope.password.targetKey="password":$scope.password.targetKey="extInfo.yiyangbaoHealInce.dealPassword",void self.updateOnesPwd($scope.password).then(function(){$scope.error.pwdResetError="",$scope.actions.preLoginP()},function(err){$scope.error.pwdResetError=err.data+", 请重新回答问题!"})):void($scope.error.pwdResetError="认证已过期, 请重新回答问题!"):void($scope.error.pwdResetError="请输入密码!")}},self.passwordModal=function($scope){$ionicModal.fromTemplateUrl("partials/modal/password.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.passwordModal=modal,$scope.passwordModal.show()}),$scope.actions=$scope.actions||{},$scope.error=$scope.error||{},$scope.password={targetKey:"password"},$scope.actions.closePassword=function(){$scope.passwordModal.hide()},$scope.actions.password=function(){self.updateOnesPwd($scope.password).then(function(){$scope.error.passwordError="",$scope.passwordModal.remove().then(function(){$scope.passwordModal=null})},function(err){$scope.error.passwordError=err.data})}},self.dealPasswordModal=function($scope,oldDealPwd,closeAble){$scope.closeAble=closeAble,$scope.oldDealPwd=oldDealPwd,$ionicModal.fromTemplateUrl("partials/modal/dealPassword.html",{scope:$scope,backdropClickToClose:!1,hardwareBackButtonClose:!1,animation:"slide-in-up"}).then(function(modal){$scope.dealPasswordModal=modal,$scope.dealPasswordModal.show()}),$scope.oldDealPwd&&self.pwdResetModal($scope),$scope.actions=$scope.actions||{},$scope.error=$scope.error||{},$scope.payBill=$scope.payBill||{},$scope.dealPassword={seriesNum:$scope.payBill.userSocketId,targetKey:"extInfo.yiyangbaoHealInce.dealPassword"},$scope.password={targetKey:"password"},$scope.actions.closeDealPassword=function(){$scope.dealPasswordModal.hide()},$scope.actions.prePwdReset=function(){$scope.dealPasswordModal.remove().then(function(){$scope.error.dealPasswordError="",$scope.dealPasswordModal=null}),$scope.actions.showPwdReset()},$scope.actions.dealPassword=function(){self.updateOnesPwd($scope.dealPassword).then(function(data){$scope.error.dealPasswordError="",$scope.dealPassword={targetKey:"extInfo.yiyangbaoHealInce.dealPassword"},$scope.dealPwd=!0,$scope.actions.check&&$scope.actions.check(),($scope.dealPassword.loginPwd||$scope.password.oldPassword)&&$scope.password.newPassword&&$scope.password.repeatPwd?($scope.password.loginPwd=$scope.dealPassword.loginPwd,$scope.password.seriesNum=$scope.dealPassword.seriesNum,self.updateOnesPwd($scope.password).then(function(data){$scope.error.passwordError="",$scope.pwdResetModal&&$scope.pwdResetModal.remove().then(function(){$scope.pwdResetModal=null}),$scope.dealPasswordModal.remove().then(function(){$scope.dealPasswordModal=null})},function(){console.log(err),$scope.error.passwordError=err.data})):($scope.pwdResetModal&&$scope.pwdResetModal.remove().then(function(){$scope.pwdResetModal=null}),$scope.dealPasswordModal.remove().then(function(){$scope.dealPasswordModal=null}))},function(err){console.log(err),$scope.error.dealPasswordError=err.data})}},self.updateModal=function($scope){$ionicModal.fromTemplateUrl("partials/modal/update.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.updateModal=modal}),$scope.actions=$scope.actions||{},$scope.error=$scope.error||{},$scope.actions.cancel=function(){$scope.updateModal.hide()},$scope.actions.show=function(textarea){$scope.error.updateError="",$scope.textarea=textarea,$scope.updateModal.show()},$scope.actions.submit=function(){if(!$scope.data.value)return void($scope.error.updateError="输入不能为空!");var upData={};upData[$scope.data.key]=$scope.data.value,self.updateOne(upData).then(function(data){$scope.error.updateError="",$scope.data={},$scope.accountInfo&&($scope.accountInfo.user=data.results,$scope.accountInfo.user.personalInfo.birthdate=new Date($scope.accountInfo.user.personalInfo.birthdate)),$scope.info&&($scope.info=data.results,$scope.info.personalInfo.birthdate=new Date($scope.info.personalInfo.birthdate)),$scope.actions.cancel()},function(err){return err.data&&err.data.name?void($scope.error.updateError="数据库写入错误!"):void($scope.error.updateError=err.data)})}},self.bindMobileModal=function(userRole,smsType,mobile,title,msg,closeAble){var $scope=$rootScope.$new();$ionicModal.fromTemplateUrl("partials/modal/bindMobile.html",{scope:$scope,animation:"slide-in-up",backdropClickToClose:!1,hardwareBackButtonClose:!1}).then(function(modal){$scope.bindMobileModal=modal,$scope.bindMobileModal.show()}),$scope.actions={},$scope.error={},$scope.data={mobile:mobile,smsType:smsType},$scope.config=$scope.config||{},$scope.config.title=title||"绑定手机",$scope.config.msg=msg||"请输入手机号",$scope.config.notCloseAble=closeAble!==!0,$scope.config.timer=0,$scope.actions.cancel=function(){$scope.bindMobileModal.hide()},$scope.actions.send=function(){return $scope.data.mobile?void Data.Interface.smsSend($scope.data,function(data,headers){$scope.error.bindMobileError="短信已发送, 请查收!",$scope.config.timer=data.results.timer,$interval(function(){$scope.config.timer--},1e3,data.results.timer)},function(err){$scope.error.bindMobileError=err.data}):void($scope.error.bindMobileError="手机号不能为空!")},$scope.actions.submit=function(){$http.defaults.headers.common.smsAuth=$scope.data.verify,$http.defaults.headers.common.smsType=smsType,$http.defaults.headers.common.smsMobile=$scope.data.mobile;var resAct="updateOne";if(!("-initBind"!==smsType||$scope.data.mobile&&$scope.data.verify))return void($scope.error.bindMobileError="输入不能为空!");if(!("-chgBind"!==smsType||$scope.data.mobile&&$scope.data.verify&&$scope.data.newMobile))return void($scope.error.bindMobileError="输入不能为空!");if("-findPwd"===smsType||"-findDealPwd"===smsType){if(!($scope.data.mobile&&$scope.data.verify&&$scope.data.newPassword&&$scope.data.repeatPwd))return void($scope.error.bindMobileError="输入不能为空!");if($scope.data.newPassword!==$scope.data.repeatPwd)return void($scope.error.bindMobileError="密码不一致!");resAct="updateOneWithSMS"}self[resAct]($scope.data).then(function(data){$scope.error.bindMobileError="",$scope.data={},$scope.bindMobileModal.remove().then(function(){$scope.bindMobileModal=null,"user"===userRole&&closeAble!==!0?self.dealPasswordModal($scope):closeAble!==!0&&self.passwordModal($scope)})},function(err){return err.data&&err.data.name?void($scope.error.bindMobileError="数据库写入错误!"):void($scope.error.bindMobileError=err.data)}),delete $http.defaults.headers.common.smsAuth,delete $http.defaults.headers.common.smsType,delete $http.defaults.headers.common.smsMobile}},self.pwdQstModal=function($scope){$ionicModal.fromTemplateUrl("partials/modal/pwdQst.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.pwdQstModal=modal,$scope.pwdQstModal.show()}),$scope.actions=$scope.actions||{},$scope.error=$scope.error||{},$scope.pwdQst=[],$scope.actions.closePwdQst=function(){$scope.pwdQstModal.hide()},$scope.actions.pwdQst=function(){return $scope.pwdQst[0]&&$scope.pwdQst[1]&&$scope.pwdQst[2]&&$scope.pwdQst[0].a&&$scope.pwdQst[1].a&&$scope.pwdQst[2].a?void self.updateOne({"accountInfo.pwdQuestions":$scope.pwdQst}).then(function(data){$scope.error.pwdQstError="",$scope.pwdQstModal.remove().then(function(){$scope.pwdQstModal=null,$scope.pwdQst=[]})},function(err){$scope.error.pwdQstError=err.data}):void($scope.error.pwdQstError="输入不能为空!")}},self.takePicsModal=function($scope,images){$ionicModal.fromTemplateUrl("partials/modal/takePics.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.takePicsModal=modal,$scope.takePicsModal.show(),$timeout(function(){$scope.slidesCount=$ionicSlideBoxDelegate.$getByHandle("takePics").slidesCount(),$ionicSlideBoxDelegate.$getByHandle("takePics").enableSlide(!1),$ionicSlideBoxDelegate.$getByHandle("takePics").update()})}),$scope.actions=$scope.actions||{},$scope.error=$scope.error||{},$scope.config=$scope.config||{},$scope.pageHandler=$scope.pageHandler||{progress:0};for(var i=0;i<images.length;i++)for(var j=0;j<$scope.config.images.length;j++)$scope.config.images[j].title===images[i].title&&($scope.config.images[j].Url=images[i].Url,$scope.config.images[j]._id=images[i]._id);var cameraOptions=angular.copy(CONFIG.cameraOptions),uploadOptions=angular.copy(CONFIG.uploadOptions);$scope.currentIndex=0,
$scope.actions.closeTakePics=function(){$scope.takePicsModal.hide()},$scope.actions.rmTakePics=function(){$scope.takePicsModal.remove().then(function(){$scope.takePicsModal=null})},$scope.actions.previous=function(){$ionicSlideBoxDelegate.$getByHandle("takePics").previous()},$scope.actions.next=function(){$ionicSlideBoxDelegate.$getByHandle("takePics").next()},$scope.actions.getIndex=function(){$scope.currentIndex=$ionicSlideBoxDelegate.$getByHandle("takePics").currentIndex(),$scope.error.takePicsError=""},$scope.actions.takePics=function(imgTitle,_id){return window.navigator&&window.navigator.camera?void $cordovaCamera.getPicture(cameraOptions).then(function(imageURI){$timeout(function(){var serverUrl=encodeURI(CONFIG.baseUrl+CONFIG.userResUploadPath);uploadOptions.headers={Authorization:"Bearer "+Storage.get("token")},uploadOptions.fileName="imgTitle"+CONFIG.uploadOptions.fileExt,uploadOptions.params={method:"$set",dest:"personalInfo.idImg",queryTitle:imgTitle,_id:_id,replace:!0,inArray:!0},PageFunc.confirm("是否上传?","上传"+imgTitle).then(function(res){if(res)return window.FileTransfer?$cordovaFileTransfer.upload(serverUrl,imageURI,uploadOptions,!0).then(function(result){$scope.pageHandler.progress=0,$scope.error.takePicsError="";var resImg=JSON.parse(result.response).results;$scope.accountInfo&&($scope.accountInfo.user.personalInfo.idImg=resImg,Storage.set("AccInfo",JSON.stringify($scope.accountInfo))),$scope.info&&($scope.info.personalInfo.idImg=resImg,Storage.set("info",JSON.stringify($scope.info)));for(var i=0;i<resImg.length;i++)for(var j=0;j<$scope.config.images.length;j++)$scope.config.images[j].title===resImg[i].title&&($scope.config.images[j].Url=resImg[i].Url,$scope.config.images[j]._id=resImg[i]._id);try{$cordovaCamera.cleanup().then(function(){console.log("Camera cleanup success.")},function(err){console.log(err)})}catch(e){console.log(e)}},function(err){$scope.error.takePicsError=err,$scope.pageHandler.progress=0;try{$cordovaCamera.cleanup().then(function(){console.log("Camera cleanup success.")},function(err){console.log(err)})}catch(e){console.log(e)}},function(progress){$scope.pageHandler.progress=progress.loaded/progress.total*100}):console.log("不支持window.FileTransfer");$scope.pageHandler.progress=0,$scope.error.takePicsError="取消上传!";try{$cordovaCamera.cleanup().then(function(){console.log("Camera cleanup success.")},function(err){console.log(err)})}catch(e){console.log(e)}})},0)},function(err){$scope.error.takePicsError=err,console.log(err)}):console.log("不支持window.navigator.camera")}},self.initAccInfo=function($scope){$scope.error={};var deferred=$q.defer();if(Storage.get("AccInfo")){$scope.accountInfo=JSON.parse(Storage.get("AccInfo"));try{$scope.accountInfo.user.personalInfo.birthdate&&($scope.accountInfo.user.personalInfo.birthdate=new Date($scope.accountInfo.user.personalInfo.birthdate))}catch(e){}}return self.getAccInfo().then(function(data){$scope.accountInfo=data.results;try{$scope.accountInfo.user.personalInfo.birthdate&&($scope.accountInfo.user.personalInfo.birthdate=new Date($scope.accountInfo.user.personalInfo.birthdate))}catch(e){}Storage.set("AccInfo",JSON.stringify(data.results)),deferred.resolve(data.results)},function(err){deferred.reject(err)}),deferred.promise},self.initInfo=function($scope){$scope.error={};var deferred=$q.defer();return Storage.get("info")&&($scope.info=JSON.parse(Storage.get("info")),$scope.info.idImgThumb=$scope.info.personalInfo.idImg.filter(function(img){return img&&(img.urlThumb=img.Url.replace(/\/([^\/]+?\.[^\/]+?)$/,"/thumb/$1")),!0}),$scope.info.personalInfo.birthdate&&($scope.info.personalInfo.birthdate=new Date($scope.info.personalInfo.birthdate))),self.getInfo().then(function(data){$scope.info=data.results,$scope.info.idImgThumb=$scope.info.personalInfo.idImg.filter(function(img){return img&&(img.urlThumb=img.Url.replace(/\/([^\/]+?\.[^\/]+?)$/,"/thumb/$1")),!0});try{$scope.info.personalInfo.birthdate&&($scope.info.personalInfo.birthdate=new Date($scope.info.personalInfo.birthdate))}catch(e){}finally{}Storage.set("info",JSON.stringify(data.results)),deferred.resolve(data.results)},function(err){deferred.reject(err)}),deferred.promise},self}]).factory("Insurance",["Storage","Data","Token","$state","$q","jwtHelper",function(Storage,Data,Token,$state,$q,jwtHelper){return{getInfo:function(query,options,fields){var deferred=$q.defer();return Data.Insurance.getInfo({query:query,options:options,fields:fields},function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},getList:function(query,options,fields){var deferred=$q.defer();return Data.Insurance.getList(query,function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},modify:function(ince,options){var deferred=$q.defer();return Data.Insurance.modify(ince,function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},remove:function(ince){var deferred=$q.defer();return Data.Insurance.remove(ince,function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},removeOne:function(ince,options){var deferred=$q.defer();return Data.Insurance.removeOne(ince,function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise}}}]).factory("Consumption",["Storage","Data","Token","$state","$q","jwtHelper",function(Storage,Data,Token,$state,$q,jwtHelper){return{insertOne:function(cons,options){var deferred=$q.defer();return Data.Consumption.insertOne(cons,function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},applyOne:function(cons,options){var deferred=$q.defer();return Data.Consumption.applyOne(cons,function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},getOne:function(query,options,fields){var deferred=$q.defer();return Data.Consumption.getOne({query:query,options:options,fields:fields},function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},getList:function(query,options,fields){var deferred=$q.defer();return Data.Consumption.getList({query:query,options:options,fields:fields},function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},updateOne:function(cons,options){var deferred=$q.defer();return Data.Consumption.updateOne(cons,function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},comment:function(cons,options){var deferred=$q.defer();return Data.Consumption.comment(cons,function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},revoking:function(cons,options){var deferred=$q.defer();return Data.Consumption.revoking(cons,function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise}}}]).factory("Post",["Storage","Data","Token","$state","$q","jwtHelper",function(Storage,Data,Token,$state,$q,jwtHelper){return{post:function(post,options){var deferred=$q.defer();return Data.Post.post(post,function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise}}}]).factory("PageFunc",["$ionicPopup","$ionicScrollDelegate","$ionicSlideBoxDelegate","$ionicModal","$timeout",function($ionicPopup,$ionicScrollDelegate,$ionicSlideBoxDelegate,$ionicModal,$timeout){return{message:function(_msg,_time,_title){var messagePopup=$ionicPopup.alert({title:_title||"消息",template:_msg,okText:"确认",okType:"button-energized"});return _time&&$timeout(function(){messagePopup.close("Timeout!")},_time),messagePopup},confirm:function(_msg,_title){var confirmPopup=$ionicPopup.confirm({title:_title,template:_msg,cancelText:"取消",cancelType:"button-default",okText:"确定",okType:"button-energized"});return confirmPopup},prompt:function(_msg,_title,type){var promptPopup=$ionicPopup.prompt({title:_title,template:_msg,inputType:type||"password",inputPlaceholder:_msg,cancelText:"取消",cancelType:"button-default",okText:"确定",okType:"button-energized"});return promptPopup},selection:function(_msg,_title,_res,$scope){var selectionPopup=$ionicPopup.show({title:_title,template:_msg,scope:$scope,buttons:[{text:"取消",type:"button-default",onTap:function(e){}},{text:"确定",type:"button-positive",onTap:function(e){return $scope[_res].selected}}]});return selectionPopup},viewer:function($scope,images,$index){$ionicModal.fromTemplateUrl("partials/modal/viewer.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.viewerModal=modal,$scope.viewerModal.show(),$timeout(function(){$scope.currentIndex=$index,$scope.slidesCount=$ionicSlideBoxDelegate.$getByHandle("viewer").slidesCount()})}),$scope.actions=$scope.actions||{},$scope.error=$scope.error||{},$scope.images=images,$scope.zoomMin=1,$scope.zoomMax=3;var tapTimeStamp,exitTimeout,tapInterval=300;$scope.actions.exit=function($event){tapTimeStamp&&$event.timeStamp-tapTimeStamp<tapInterval?$timeout.cancel(exitTimeout):(tapTimeStamp=$event.timeStamp,exitTimeout=$timeout(function(){$scope.viewerModal.remove().then(function(){})},tapInterval))},$scope.actions.zoom=function($index){var zoomFactor=$ionicScrollDelegate.$getByHandle("scrollHandle"+$index).getScrollPosition().zoom;zoomFactor===$scope.zoomMax?$ionicScrollDelegate.$getByHandle("scrollHandle"+$index).zoomTo(1,!0):$ionicScrollDelegate.$getByHandle("scrollHandle"+$index).zoomBy(2,!0)},$scope.actions.updateSlideStatus=function($index){var zoomFactor=$ionicScrollDelegate.$getByHandle("scrollHandle"+$index).getScrollPosition().zoom;zoomFactor===$scope.zoomMin?$ionicSlideBoxDelegate.enableSlide(!0):$ionicSlideBoxDelegate.enableSlide(!1)},$scope.actions.getIndex=function(){$scope.currentIndex=$ionicSlideBoxDelegate.$getByHandle("viewer").currentIndex()}}}}]).factory("barcodeXs",["$ionicPopup","$ionicScrollDelegate","$ionicSlideBoxDelegate","$ionicModal","$timeout","Insurance","User","PageFunc",function($ionicPopup,$ionicScrollDelegate,$ionicSlideBoxDelegate,$ionicModal,$timeout,Insurance,User,PageFunc){var self=this;return self.routes=function(barcode,role,func){0===barcode.indexOf("ONLP")?self[role].barCodePay(barcode):self[role][func](barcode)},self.user={bindBarcode:function(barcode){User.bindBarcode({query:"whatever",barcode:barcode}).then(function(data){var results=data.results;return"OK"===results?PageFunc.message("卡号绑定成功!",1e3):void(results.length>0&&($scope.selection={inces:results},$scope.ince={selected:results[0]},PageFunc.selection('<select ng-options="_ince.unit for _ince in selection.inces" ng-model="ince.selected"></select>',"请选择需要绑定的保单","ince",$scope).then(function(res){res&&Insurance.modify({inceObj:{_id:res._id,seriesNum:barcode}}).then(function(data){PageFunc.message("卡号绑定成功!",1e3)},function(err){PageFunc.message(err.data,1e3)})})))},function(err){PageFunc.message(err.data,1e3)})},barCodePay:function(barcode){PageFunc.prompt("消费金额","请输入消费金额","number").then(function(res){parseFloat(res)>0&&PageFunc.prompt("支付密码","请输入支付密码").then(function(pwd){pwd&&User.barCodePay({barcode:barcode,pwd:pwd,amount:res}).then(function(data){return"ok"===data.results?PageFunc.message("支付成功!",2e3):void 0},function(err){PageFunc.message(err.data,2e3)})})})},general:function(barcode){}},self}]).factory("Auth",["Storage","Data","$q","ACL","Token",function(Storage,Data,$q,ACL,Token){return{authorize:function(accessLevel,role){return void 0===role&&(role=ACL.userRoles[Token.curUserRole()]),accessLevel.bitMask&role.bitMask},isLoggedIn:function(){return!Token.isExpired()}}}]),function(exports){function buildRoles(roles){var bitMask="01",userRoles={};for(var role in roles){var intCode=parseInt(bitMask,2);userRoles[roles[role]]={bitMask:intCode,title:roles[role]},bitMask=(intCode<<1).toString(2)}return userRoles}function buildAccessLevels(accessLevelDeclarations,userRoles){var accessLevels={};for(var level in accessLevelDeclarations)if("string"==typeof accessLevelDeclarations[level])if("*"==accessLevelDeclarations[level]){var resultBitMask="";for(var role in userRoles)resultBitMask+="1";accessLevels[level]={bitMask:parseInt(resultBitMask,2)}}else console.log("Access Control Error: Could not parse '"+accessLevelDeclarations[level]+"' as access definition for level '"+level+"'");else{var resultBitMask=0;for(var role in accessLevelDeclarations[level])userRoles.hasOwnProperty(accessLevelDeclarations[level][role])?resultBitMask|=userRoles[accessLevelDeclarations[level][role]].bitMask:console.log("Access Control Error: Could not find role '"+accessLevelDeclarations[level][role]+"' in registered roles while building access for '"+level+"'");accessLevels[level]={bitMask:resultBitMask}}return accessLevels}var config={roles:["public","user","serv","unit","medi","ince","admin","super"],accessLevels:{"public":"*",anon:["public"],user:["user","serv","unit","medi","ince","admin","super"],serv:["serv","super"],unit:["unit","super"],medi:["medi","super"],ince:["ince","super"],admin:["admin","super"]}};exports.userRoles=buildRoles(config.roles),exports.accessLevels=buildAccessLevels(config.accessLevels,exports.userRoles)}("undefined"==typeof exports?this.routingConfig={}:exports);